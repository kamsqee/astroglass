---
/**
 * FileTree Component
 * 
 * Display a directory tree structure with expand/collapse functionality.
 * Features:
 * - VS Code-like aesthetics
 * - SVG Icons (File, Folder, Open Folder)
 * - Indentation guides
 * - Glassmorphism container
 */
import '../../styles/components/mdx/FileTree.css';
---

<div class="c-file-tree group relative rounded-xl border border-white/10 bg-[#0f0f11] p-4 text-sm font-mono leading-6 text-white/80 shadow-2xl transition-all hover:border-white/20 hover:shadow-3xl">
  <div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
  <div class="c-file-tree__list" data-file-tree>
    <slot />
  </div>
</div>

<script>
  // Icons as SVG strings
  const ICONS = {
    file: `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" class="opacity-80" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
    folder: `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="opacity-100"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    folderOpen: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>`
  };

  function initFileTree() {
    document.querySelectorAll('[data-file-tree]').forEach((tree) => {
      // Process all LI elements
      const listItems = Array.from(tree.querySelectorAll('li'));
      
      listItems.forEach((li) => {
        // Prevent double processing
        if (li.querySelector('.c-file-tree__row')) return;

        // Extract text content and comments
        // Expect format: "filename.ext # comment"
        let fullText = '';
        
        // clone children to preserve structure, but we only want text node before the UL
        const childNodes = Array.from(li.childNodes);
        const textNodes = childNodes.filter(n => n.nodeType === Node.TEXT_NODE);
        fullText = textNodes.map(n => n.textContent).join('').trim();
        
        // Remove text nodes from DOM as we will rebuild the row
        textNodes.forEach(n => n.remove());

        // Parse content
        const [namePart, commentPart] = fullText.split('#').map(s => s.trim());
        const isFolder = namePart.endsWith('/') || li.querySelector('ul');
        const fileName = namePart.replace(/\/$/, ''); // Remove trailing slash for display

        // Create Row Container
        const row = document.createElement('div');
        row.className = 'c-file-tree__row';

        // Icon
        const iconSpan = document.createElement('span');
        iconSpan.className = 'c-file-tree__icon';
        iconSpan.innerHTML = isFolder ? ICONS.folder : ICONS.file;
        row.appendChild(iconSpan);

        // Content
        const contentSpan = document.createElement('div');
        contentSpan.className = 'c-file-tree__content';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'c-file-tree__name';
        nameSpan.textContent = fileName;
        contentSpan.appendChild(nameSpan);

        if (commentPart) {
          const commentSpan = document.createElement('span');
          commentSpan.className = 'c-file-tree__comment';
          commentSpan.textContent = `// ${commentPart}`;
          contentSpan.appendChild(commentSpan);
        }

        row.appendChild(contentSpan);

        // Insert row at beginning of LI
        li.prepend(row);

        // Handle Folder Logic
        if (isFolder) {
          li.classList.add('is-folder');
          // Default to open
          li.classList.add('is-open'); // can toggle if needed

          // Click handler for toggle
          row.style.cursor = 'pointer';
          row.onclick = (e) => {
            e.stopPropagation();
            li.classList.toggle('is-open');
            const isOpen = li.classList.contains('is-open');
            
            // Icon toggle
            iconSpan.innerHTML = isOpen ? ICONS.folderOpen : ICONS.folder; // actually folderOpen looks weird filled, lets swap logic or keep simple
            // Better logic: Filled folder = closed, Open outline = open? Or just standardize.
            // Let's stick to: Filled folder for both for now, or use a specific open icon.
            // Updating icon to open folder
             iconSpan.innerHTML = isOpen ? ICONS.folder : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="opacity-60"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`; 

            // Sublist toggle
            const subList = li.querySelector('ul');
            if (subList) {
               if (isOpen) {
                 subList.classList.remove('is-hidden');
               } else {
                 subList.classList.add('is-hidden');
               }
            }
          };
        }
      });
    });
  }

  initFileTree();
  document.addEventListener('astro:after-swap', initFileTree);
</script>

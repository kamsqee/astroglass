---
/**
 * FAQ Glass - The Conversational Thread
 * Chat-style interface with message bubbles and suggested questions.
 * Mobile: Native chat feel. Desktop: Centered chat with category sidebar.
 */
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

import '../../../styles/components/faq/FAQGlass.css';
import SectionTag from '../../ui/glass/SectionTag.astro';
import SectionHeading from '../../ui/glass/SectionHeading.astro';

import { Input } from '../../ui/input';
import { Button } from '../../ui/button';

const faqs = [
  { q: t('faq.q1'), a: t('faq.a1'), category: "basics" },
  { q: t('faq.q2'), a: t('faq.a2'), category: "basics" },
  { q: t('faq.q3'), a: t('faq.a3'), category: "billing" },
  { q: t('faq.q4'), a: t('faq.a4'), category: "billing" },
  { q: t('faq.q5'), a: t('faq.a5'), category: "technical" },
  { q: t('faq.q6'), a: t('faq.a6'), category: "technical" },
  { q: t('faq.q7'), a: t('faq.a7'), category: "account" },
  { q: t('faq.q8'), a: t('faq.a8'), category: "account" },
];

const i18nData = JSON.stringify({
  faqs,
  botFallback: t('faq.botFallback'),
  justNow: t('testimonial.justNow'),
  helpful: t('faq.helpful'),
  thanks: t('faq.thanks')
});
---

<section id="faq" class="relative py-24 lg:py-32 px-6 overflow-hidden bg-base-100">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-12">
       <SectionTag label={t('faq.ask')} icon="üí¨" class="mb-6" />
       <SectionHeading size="md" align="center">{t('faq.title')}</SectionHeading>
       <p class="text-base text-base-content/75 mt-4">{t('faq.subtitle')}</p>
    </div>

    <!-- Chat Container -->
    <div class="c-faq-glass__chat relative max-w-2xl mx-auto" data-i18n={i18nData}>
       <!-- Messages Area -->
       <div class="c-faq-glass__messages space-y-4 mb-6 min-h-[200px] max-h-[400px] overflow-y-auto c-faq-glass__scrollbar py-3 px-1" id="faq-glass-messages">
          <!-- Welcome message -->
          <div class="c-faq-glass__msg c-faq-glass__msg-bot flex gap-3 items-start">
             <div class="w-12 h-12 min-w-[3rem] min-h-[3rem] rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0 ring-2 ring-accent/20 ring-offset-2 ring-offset-base-100">
                <span class="text-xl leading-none">ü§ñ</span>
             </div>
             <div class="flex-1">
                <div class="inline-block p-4 rounded-2xl rounded-tl-md bg-base-content/[0.04] border border-base-content/5 backdrop-blur-sm">
                   <p class="text-sm text-base-content/70">{t('faq.botWelcome')}</p>
                </div>
                <p class="text-[10px] text-base-content/60 mt-1 ml-2">{t('testimonial.justNow')}</p>
             </div>
          </div>
       </div>

       <!-- Suggested Questions -->
       <div class="c-faq-glass__suggestions mb-6" id="faq-glass-suggestions">
          <p class="text-xs text-base-content/80 mb-3">{t('faq.popularQuestions')}</p>
          <div class="flex flex-wrap gap-2">
             {faqs.slice(0, 6).map(faq => (
                <Button 
                  variant="soft"
                  size="sm"
                  className="c-faq-glass__suggest-btn rounded-full border border-base-content/10 text-base-content/75 hover:text-base-content transition-all duration-[1200ms] ease-[cubic-bezier(0.16,1,0.3,1)]"
                  data-question={faq.q}
                  data-answer={faq.a}
                >
                   {faq.q}
                </Button>
             ))}
          </div>
       </div>

       <!-- Input Area -->
       <div class="c-faq-glass__input-area flex gap-3 p-4 rounded-2xl bg-base-content/[0.02] border border-base-content/10 focus-within:border-accent/30 focus-within:bg-base-content/[0.04] transition-all duration-[1200ms] ease-[cubic-bezier(0.16,1,0.3,1)]">
          <Input 
            type="text" 
            id="faq-glass-input"
            placeholder={t('faq.typeQuestion')} 
            className="flex-1 bg-transparent text-base-content placeholder:text-base-content/80 border-none shadow-none focus-visible:ring-0 text-sm h-auto p-0"
          />
          <Button id="faq-glass-send" className="c-faq-glass__ask-btn px-5 py-2.5 h-auto rounded-xl bg-accent text-base-100 text-sm font-bold hover:bg-accent/90 hover:scale-105 active:scale-95 transition-all duration-500 relative overflow-hidden">
             <span class="relative z-10">{t('faq.ask')}</span>
             <div class="c-faq-glass__ask-shine absolute inset-0 pointer-events-none"></div>
          </Button>
       </div>
    </div>
  </div>
</section>

<script>
  let faqGlassController: AbortController | null = null;

  function initFAQGlassChat() {
    // Abort previous listeners
    faqGlassController?.abort();
    faqGlassController = new AbortController();
    const signal = faqGlassController.signal;

    const chatContainer = document.querySelector('.c-faq-glass__chat') as HTMLElement;
    if (!chatContainer) return;

    const i18nData = JSON.parse(chatContainer.dataset.i18n || '{}');
    const faqs = i18nData.faqs || [];
    const botFallback = i18nData.botFallback || "I'm not sure about that one.";
    const justNow = i18nData.justNow || "Just now";
    const helpful = i18nData.helpful || "Helpful";
    const thanks = i18nData.thanks || "Thanks!";
    
    const messagesContainer = document.getElementById('faq-glass-messages');
    const suggestionsContainer = document.getElementById('faq-glass-suggestions');
    const input = document.getElementById('faq-glass-input') as HTMLInputElement;
    const sendBtn = document.getElementById('faq-glass-send');

    function showTypingIndicator() {
      // Create typing indicator dynamically at the bottom
      const typing = document.createElement('div');
      typing.className = 'faq-glass-typing c-faq-glass__msg flex gap-3 items-start';
      typing.innerHTML = `
        <div class="w-12 h-12 min-w-[3rem] min-h-[3rem] rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0">
          <span class="text-xl leading-none">ü§ñ</span>
        </div>
        <div class="inline-flex items-center gap-1.5 px-4 py-3 rounded-2xl rounded-tl-md bg-base-content/[0.04] border border-base-content/5">
          <div class="c-faq-glass__typing-dot w-2 h-2 rounded-full bg-base-content/30"></div>
          <div class="c-faq-glass__typing-dot w-2 h-2 rounded-full bg-base-content/30"></div>
          <div class="c-faq-glass__typing-dot w-2 h-2 rounded-full bg-base-content/30"></div>
        </div>
      `;
      messagesContainer?.appendChild(typing);
      messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    }

    function hideTypingIndicator() {
      const typing = messagesContainer?.querySelector('.faq-glass-typing');
      typing?.remove();
    }

    function addUserMessage(text: string) {
      const msg = document.createElement('div');
      msg.className = 'c-faq-glass__msg c-faq-glass__msg-user flex gap-3 justify-end items-start';
      msg.innerHTML = `
        <div class="flex-1 text-right">
          <div class="inline-block p-4 rounded-2xl rounded-tr-md bg-accent text-base-100">
            <p class="text-sm">${text}</p>
          </div>
          <p class="text-[10px] text-base-content/60 mt-1 mr-2">${justNow}</p>
        </div>
        <div class="w-12 h-12 min-w-[3rem] min-h-[3rem] rounded-full bg-base-content/10 flex items-center justify-center flex-shrink-0">
          <span class="text-xl leading-none">üë§</span>
        </div>
      `;
      messagesContainer?.appendChild(msg);
      messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    }

    function addBotMessage(text: string, showFeedback = true) {
      const msgId = 'msg-' + Date.now();
      const msg = document.createElement('div');
      msg.className = 'c-faq-glass__msg c-faq-glass__msg-bot flex gap-3 items-start';
      msg.innerHTML = `
        <div class="w-12 h-12 min-w-[3rem] min-h-[3rem] rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0 ring-2 ring-accent/20 ring-offset-2 ring-offset-base-100">
          <span class="text-xl leading-none">ü§ñ</span>
        </div>
        <div class="flex-1">
          <div class="inline-block p-4 rounded-2xl rounded-tl-md bg-base-content/[0.04] border border-base-content/5 backdrop-blur-sm">
            <p class="text-sm text-base-content/70">${text}</p>
          </div>
          ${showFeedback ? `
            <div class="c-faq-glass__feedback flex gap-3 mt-2 ml-2 items-center" data-msg="${msgId}">
              <button class="c-faq-glass__helpful-btn c-faq-glass__helpful-yes text-xs text-base-content/75 hover:text-accent hover:scale-110 transition-all duration-500" data-vote="yes">üëç ${helpful}</button>
              <button class="c-faq-glass__helpful-btn c-faq-glass__helpful-no text-xs text-base-content/75 hover:text-base-content/70 hover:scale-110 transition-all duration-500" data-vote="no">üëé</button>
              <span class="c-faq-glass__thanks hidden text-xs text-accent ml-1">${thanks}</span>
            </div>
          ` : ''}
          <p class="text-[10px] text-base-content/60 mt-1 ml-2">${justNow}</p>
        </div>
      `;
      messagesContainer?.appendChild(msg);
      
      // Bind helpful button clicks
      const feedback = msg.querySelector('.c-faq-glass__feedback');
      feedback?.querySelectorAll('.c-faq-glass__helpful-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const vote = (btn as HTMLElement).dataset.vote;
          const thanksEl = feedback.querySelector('.c-faq-glass__thanks');
          
          feedback.querySelectorAll('.c-faq-glass__helpful-btn').forEach(b => {
            if (b === btn) {
              // Chosen one: bright and bold
              b.classList.add('chosen');
              b.classList.remove('text-base-content/75');
              if (vote === 'yes') {
                b.classList.add('text-accent', 'font-bold');
              } else {
                b.classList.add('text-base-content', 'font-bold');
              }
            } else {
              // Not chosen: faded
              b.classList.add('not-chosen', 'opacity-30', 'pointer-events-none');
            }
          });
          
          thanksEl?.classList.remove('hidden');
        }, { signal });
      });
      messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    }

    function findAnswer(question: string) {
      const q = question.toLowerCase();
      const match = faqs.find((faq: any) => 
        faq.q.toLowerCase().includes(q) || 
        q.includes(faq.q.toLowerCase().split(' ').slice(0, 3).join(' '))
      );
      return match?.a || botFallback;
    }

    function handleQuestion(question: string, answer: string | null = null) {
      addUserMessage(question);
      showTypingIndicator();
      
      setTimeout(() => {
        hideTypingIndicator();
        addBotMessage(answer || findAnswer(question));
        updateSuggestions(question);
      }, 800 + Math.random() * 400);
    }

    function updateSuggestions(askedQuestion: string) {
      const remaining = faqs.filter((f: any) => f.q !== askedQuestion).slice(0, 4);
      const suggestionsDiv = suggestionsContainer?.querySelector('.flex.flex-wrap');
      if (suggestionsDiv && remaining.length > 0) {
        suggestionsDiv.innerHTML = remaining.map((faq: any) => `
          <button 
            class="c-faq-glass__suggest-btn px-4 py-2.5 rounded-full bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content/75 hover:bg-base-content/[0.08] hover:border-base-content/20 hover:text-base-content transition-all duration-[1200ms]"
            data-question="${faq.q}"
            data-answer="${faq.a}"
          >
            ${faq.q}
          </button>
        `).join('');
        bindSuggestionClicks();
      }
    }

    function bindSuggestionClicks() {
      document.querySelectorAll('.c-faq-glass__suggest-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const q = (btn as HTMLElement).dataset.question || '';
          const a = (btn as HTMLElement).dataset.answer || '';
          handleQuestion(q, a);
        }, { signal });
      });
    }

    // Initial binding
    bindSuggestionClicks();

    // Send button
    sendBtn?.addEventListener('click', () => {
      const q = input?.value.trim();
      if (q) {
        handleQuestion(q);
        input.value = '';
      }
    }, { signal });

    // Enter key
    input?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = input.value.trim();
        if (q) {
          handleQuestion(q);
          input.value = '';
        }
      }
    }, { signal });
  }

  initFAQGlassChat();
  document.addEventListener('astro:after-swap', initFAQGlassChat);
</script>

---
/**
 * Theme Gallery â€” Enhanced horizontal scrolling showcase
 * Shows all available themes with icons, section counts, and premium/free badges.
 */
import '../../../styles/components/portfolio/PortfolioGlass.css';
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';
import LocalizedLink from '../../ui/LocalizedLink.astro';
import { themes } from '../../../config/themes';
import { Image } from 'astro:assets';

// Import all theme backgrounds eager-loaded
const themeImages = import.meta.glob<{ default: ImageMetadata }>('/src/assets/themes/*CardBg.png', { eager: true });

const getThemeImage = (id: string) => {
  const name = id.charAt(0).toUpperCase() + id.slice(1);
  return themeImages[`/src/assets/themes/${name}CardBg.png`]?.default;
};

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const themeItems = themes.filter(t => t.enabled).map((theme, i) => ({
  id: i + 1,
  title: theme.name,
  desc: theme.description,
  category: theme.premium ? t('portfolio.themeGallery.premium') : t('portfolio.themeGallery.free'),
  isPremium: theme.premium,
  num: `0${i + 1}`,
  realId: theme.id,
  color: theme.color,
  icon: theme.icon,
  sectionCount: theme.sections.length,
}));
---

<section id="themes" class="relative py-16 sm:py-24 md:py-32 bg-base-content/[0.01] overflow-hidden">
  <!-- Header -->
  <div class="px-4 sm:px-6 mb-10 sm:mb-14 max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-end justify-between gap-4">
    <div>
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-accent/20 bg-accent/[0.06] text-base-content/80 text-[10px] font-bold uppercase tracking-[0.3em] mb-3">
        <span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span>
        {t('portfolio.themeGallery.subtitle')}
      </div>
      <h2 class="text-4xl sm:text-5xl md:text-7xl font-black text-base-content tracking-tight leading-none">
        {t('portfolio.themeGallery.title')}
      </h2>
    </div>
    <p class="text-sm sm:text-base text-base-content/75 max-w-xs">
      {t('portfolio.themeGallery.desc')}
    </p>
  </div>

  <!-- Carousel -->
  <div class="relative">
    <div class="c-portfolio-glass__container flex gap-4 sm:gap-6 px-4 sm:px-6 lg:px-[8vw] pt-10 pb-16 sm:pb-20 overflow-x-auto snap-x snap-mandatory">
      {themeItems.map((p, i) => (
        <LocalizedLink href={`/${p.realId}`} class="c-portfolio-glass__item group flex-shrink-0 w-[75vw] sm:w-[65vw] md:w-[55vw] lg:w-[42vw] aspect-[3/4] sm:aspect-[4/3] relative snap-center" style={`animation-delay: ${i * 100}ms`}>
          <div class="absolute inset-0 bg-base-content/[0.02] backdrop-blur-xl border border-base-content/10 rounded-2xl sm:rounded-3xl overflow-hidden shadow-xl transition-all duration-700 group-hover:scale-[1.02] group-hover:shadow-2xl group-hover:border-accent/20">
            {/* Background Image (If available) */}
            {getThemeImage(p.realId) && (
              <Image 
                src={getThemeImage(p.realId)} 
                alt={`${p.title} theme background`} 
                width={800}
                class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-60 transition-opacity duration-700" 
              />
            )}
            
            {/* Background gradient from theme config */}
            <div class={`absolute inset-0 bg-gradient-to-br ${p.color} opacity-10 group-hover:opacity-30 transition-opacity duration-700 mix-blend-overlay`} data-theme-gradient></div>

            {/* Gradient overlay */}
            <div class="absolute inset-0 bg-gradient-to-tr from-accent/10 via-base-100/30 to-primary/10 opacity-80 group-hover:opacity-100 transition-opacity duration-700" data-theme-gradient></div>
            
            <div class="relative z-10 h-full p-6 sm:p-8 lg:p-10 flex flex-col justify-between">
              {/* Top */}
              <div class="flex items-start justify-between">
                <div class="flex items-center gap-3">
                  <span class={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider ${p.isPremium ? 'bg-amber-500/10 text-amber-500' : 'bg-accent/10 text-accent'}`}>
                    {p.category}
                  </span>
                </div>
              </div>
              
              {/* Bottom */}
              <div>
                <div class="flex items-baseline gap-3 mb-3">
                  <span class="text-4xl sm:text-5xl font-black text-base-content/5 group-hover:text-base-content/10 transition-colors duration-500">{p.num}</span>
                </div>
                <h3 class="text-2xl sm:text-3xl lg:text-4xl font-black text-base-content mb-2 sm:mb-3 tracking-tight group-hover:text-accent transition-colors duration-500">
                  {p.title}
                </h3>
                <p class="text-sm sm:text-base text-base-content/75 font-medium max-w-md mb-4 sm:mb-6 group-hover:text-base-content/75 transition-colors duration-500 line-clamp-2 sm:line-clamp-none">
                  {p.desc}
                </p>
                <div class="inline-flex items-center gap-3 text-accent font-bold text-xs uppercase tracking-widest hover:gap-5 transition-all duration-300">
                  {t('portfolio.themeGallery.viewDemo')}
                  <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </LocalizedLink>
      ))}
    </div>
    
    <!-- Scroll hint controls -->
    <div class="flex items-center justify-center gap-4 mt-4 pb-4">
      <button id="theme-gallery-prev" aria-label="Scroll left" class="p-2 text-base-content hover:text-accent transition-all hover:-translate-x-1 outline-none focus-visible:ring-2 focus-visible:ring-accent rounded-full flex-shrink-0">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </button>
      <span class="text-[10px] font-bold uppercase tracking-widest text-base-content whitespace-nowrap">{t('portfolio.scrollHint')}</span>
      <button id="theme-gallery-next" aria-label="Scroll right" class="p-2 text-base-content hover:text-accent transition-all hover:translate-x-1 outline-none focus-visible:ring-2 focus-visible:ring-accent rounded-full flex-shrink-0">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
  function initThemeGalleryScroll() {
    const container = document.querySelector('#themes .c-portfolio-glass__container');
    const prevBtn = document.getElementById('theme-gallery-prev');
    const nextBtn = document.getElementById('theme-gallery-next');

    if (!container || !prevBtn || !nextBtn) return;

    const scrollAmount = window.innerWidth * 0.6; // Scroll roughly 60vw so the next card is mostly centered

    const handlePrev = () => container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    const handleNext = () => container.scrollBy({ left: scrollAmount, behavior: 'smooth' });

    prevBtn.addEventListener('click', handlePrev);
    nextBtn.addEventListener('click', handleNext);
  }

  // Initialize on full load and Astro page swaps
  initThemeGalleryScroll();
  document.addEventListener('astro:after-swap', initThemeGalleryScroll);
</script>

<style>
  /* Monochrome visual overrides */
  :global([data-palette="monochrome"]) .c-portfolio-glass__item [data-theme-gradient] {
    background-image: none;
  }

  :global([data-palette="monochrome"]) .group:hover .group-hover\:border-accent\/20 {
    border-color: hsl(var(--bc) / 0.2);
  }
</style>

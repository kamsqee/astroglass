---
/**
 * Contact Aurora - Aurora Split Form
 * Left info panel with reasons/trust signals, right contact form.
 * Includes client-side validation with i18n error messages.
 */
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
import '../../../styles/components/contact/ContactAurora.css';

const validationMessages = {
  nameShort: t('contact.validation.nameShort'),
  nameLong: t('contact.validation.nameLong'),
  emailInvalid: t('contact.validation.emailInvalid'),
  messageShort: t('contact.validation.messageShort'),
  messageLong: t('contact.validation.messageLong'),
  required: t('contact.validation.required'),
};
---

<section class="contact-aurora" id="contact" data-validation-messages={JSON.stringify(validationMessages)}>
  <div class="contact-aurora-inner">
    <!-- Left panel -->
    <div class="contact-aurora-info">
      <div class="contact-aurora-label">
        <span class="contact-aurora-label-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
        </span>
        <span>{t('contact.eyebrow')}</span>
      </div>
      <h2 class="contact-aurora-title">{t('contact.title')}</h2>
      <p class="contact-aurora-desc">{t('contact.subtitle')}</p>

      <ul class="contact-aurora-reasons">
        <li>
          <span class="contact-aurora-reason-icon">→</span>
          <span>{t('contact.split.reason1')}</span>
        </li>
        <li>
          <span class="contact-aurora-reason-icon">→</span>
          <span>{t('contact.split.reason2')}</span>
        </li>
        <li>
          <span class="contact-aurora-reason-icon">→</span>
          <span>{t('contact.split.reason3')}</span>
        </li>
        <li>
          <span class="contact-aurora-reason-icon">→</span>
          <span>{t('contact.split.reason4')}</span>
        </li>
      </ul>

      <div class="contact-aurora-trust-signals">
        <div class="contact-aurora-trust-item">
          <span class="contact-aurora-trust-icon">●</span>
          <span>{t('contact.split.trusted')}</span>
        </div>
        <div class="contact-aurora-trust-item">
          <span class="contact-aurora-trust-icon">●</span>
          <span>{t('contact.split.response')}</span>
        </div>
      </div>
    </div>

    <!-- Right panel — form -->
    <div class="contact-aurora-form-wrapper">
      <form class="contact-aurora-form" id="aurora-contact-form" novalidate>
        <div class="contact-aurora-row">
          <div class="contact-aurora-field">
            <label for="aurora-name">{t('contact.form.name')}</label>
            <input type="text" id="aurora-name" name="name" placeholder={t('contact.placeholders.johnSmith')} required minlength="2" maxlength="100" autocomplete="name" />
            <span class="contact-aurora-error" data-error-for="aurora-name" aria-live="polite"></span>
          </div>
          <div class="contact-aurora-field">
            <label for="aurora-email">{t('contact.form.email')}</label>
            <input type="email" id="aurora-email" name="email" placeholder={t('contact.placeholders.yourEmail')} required autocomplete="email" />
            <span class="contact-aurora-error" data-error-for="aurora-email" aria-live="polite"></span>
          </div>
        </div>
        <div class="contact-aurora-field">
          <label for="aurora-topic">{t('contact.form.topic')}</label>
          <select id="aurora-topic" name="topic">
            <option value="">{t('contact.placeholders.selectTopic')}</option>
            <option value="general">{t('contact.topics.general')}</option>
            <option value="sales">{t('contact.topics.sales')}</option>
            <option value="support">{t('contact.topics.support')}</option>
            <option value="partnership">{t('contact.topics.partnership')}</option>
          </select>
        </div>
        <div class="contact-aurora-field">
          <label for="aurora-message">{t('contact.form.message')}</label>
          <textarea id="aurora-message" name="message" rows="4" placeholder={t('contact.placeholders.tellUs')} required minlength="10" maxlength="2000"></textarea>
          <span class="contact-aurora-error" data-error-for="aurora-message" aria-live="polite"></span>
        </div>
        <button type="submit" class="contact-aurora-submit" id="aurora-submit-btn">
          <span class="contact-aurora-submit-text">{t('contact.form.send')}</span>
          <span class="contact-aurora-submit-loading" style="display:none;">{t('contact.form.sending')}</span>
        </button>
        <p class="contact-aurora-success" id="aurora-success" style="display:none;">{t('contact.form.success')}</p>
        <p class="contact-aurora-privacy">{t('contact.secureInfo')}</p>
      </form>
    </div>
  </div>
</section>

<script>
  import { createContactSchema } from '../../../lib/schemas/contact';
  import { validateSingleField, validateForm } from '../../../utils/form-validation';

  let contactAuroraController: AbortController | null = null;

  function initAuroraForm() {
    contactAuroraController?.abort();
    contactAuroraController = new AbortController();
    const signal = contactAuroraController.signal;

    const container = document.querySelector('.contact-aurora');
    if (!container) return;
    
    const form = document.getElementById('aurora-contact-form') as HTMLFormElement;
    if (!form) return;

    const validationMessages = JSON.parse((container as HTMLElement).dataset.validationMessages || '{}');
    const t = (key: string) => validationMessages[key.split('.').pop() || ''] || key;
    const schema = createContactSchema(t);

    const renderError = (input: HTMLElement, message: string) => {
      const fieldId = input.id;
      const el = form.querySelector(`[data-error-for="${fieldId}"]`);
      if (el) el.textContent = message;
      input.classList.add('contact-aurora-input--error');
    };

    const clearError = (input: HTMLElement) => {
      const fieldId = input.id;
      const el = form.querySelector(`[data-error-for="${fieldId}"]`);
      if (el) el.textContent = '';
      input.classList.remove('contact-aurora-input--error');
    };

    // Real-time validation
    form.querySelectorAll('input, select, textarea').forEach(input => {
      const el = input as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
      el.addEventListener('blur', () => {
         validateSingleField(el, { form, schema, renderError, clearError });
      }, { signal });
      el.addEventListener('input', () => {
        if (el.classList.contains('contact-aurora-input--error')) {
           validateSingleField(el, { form, schema, renderError, clearError });
        }
      }, { signal });
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const result = validateForm({ form, schema, renderError, clearError });

      if (!result.success) {
        return;
      }

      // Simulate form submission
      const submitBtn = document.getElementById('aurora-submit-btn') as HTMLButtonElement | null;
      const textEl = submitBtn?.querySelector('.contact-aurora-submit-text') as HTMLElement | null;
      const loadingEl = submitBtn?.querySelector('.contact-aurora-submit-loading') as HTMLElement | null;
      
      if (textEl) textEl.style.display = 'none';
      if (loadingEl) loadingEl.style.display = 'inline';
      if (submitBtn) submitBtn.disabled = true;

      setTimeout(() => {

        if (textEl) textEl.style.display = 'inline';
        if (loadingEl) loadingEl.style.display = 'none';
        if (submitBtn) submitBtn.disabled = false;
        
        const success = document.getElementById('aurora-success');
        if (success) success.style.display = 'block';
        
        form.reset();
        
        setTimeout(() => { if (success) success.style.display = 'none'; }, 5000);
      }, 1500);
    }, { signal });
  }

  initAuroraForm();
  document.addEventListener('astro:after-swap', initAuroraForm);
</script>

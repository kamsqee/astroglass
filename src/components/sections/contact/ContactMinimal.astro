---
/**
 * Contact Minimal - The Contextual Wizard
 * First question determines the flow.
 * Different paths for Sales, Support, Partnerships.
 */
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';
import enContact from '../../../locales/en/contact.json';
import ruContact from '../../../locales/ru/contact.json';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const contactData = locale === 'ru' ? ruContact : enContact;

const intents = [
  { id: 'sales', icon: 'üíº', label: t('contact.intents.sales'), desc: t('contact.intents.salesDesc') },
  { id: 'support', icon: 'üõ†', label: t('contact.intents.support'), desc: t('contact.intents.supportDesc') },
  { id: 'partnership', icon: 'ü§ù', label: t('contact.intents.partnership'), desc: t('contact.intents.partnershipDesc') },
  { id: 'other', icon: 'üí¨', label: t('contact.intents.other'), desc: t('contact.intents.otherDesc') },
];

const i18nData = {
  fields: contactData.wizard.fields,
  placeholders: contactData.wizard.placeholders,
  teams: contactData.wizard.teams,
  successMsg: contactData.wizard.successMsg
};
  // Validation config
  const validationMessages = {
    nameShort: t('contact.validation.nameShort'),
    nameLong: t('contact.validation.nameLong'),
    emailInvalid: t('contact.validation.emailInvalid'),
    messageShort: t('contact.validation.messageShort'),
    messageLong: t('contact.validation.messageLong'),
    required: t('contact.validation.required')
  };
import '../../../styles/components/contact/ContactMinimal.css';
import '../../../styles/components/tag/TagMinimal.css';
---

<section id="contact" class="relative py-16 lg:py-24 px-4 sm:px-6 overflow-hidden bg-base-100">
  <!-- Background -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute top-1/3 left-1/2 -translate-x-1/2 w-[500px] h-[400px] bg-accent/5 rounded-full blur-[150px]"></div>
  </div>

  <div class="max-w-xl mx-auto relative">
    <!-- Header -->
    <div class="text-center mb-8">
      <span class="c-tag-minimal mb-2 block"><span class="c-tag-minimal__dash"></span>{t('contact.contactUs')}</span>
      <h2 class="text-3xl sm:text-5xl md:text-6xl font-black text-base-content tracking-tighter">{t('contact.howCanWeHelp')}</h2>
    </div>

    <!-- Wizard Container -->
    <div 
      class="contact-minimal-wizard" 
      data-intents={JSON.stringify(intents)} 
      data-i18n={JSON.stringify(i18nData)}
      data-validation-messages={JSON.stringify(validationMessages)}
    >
      
      <!-- Progress Steps -->
      <div class="flex items-center justify-center gap-2 mb-8">
        <div class="contact-minimal-step flex items-center gap-2 text-accent" data-step="1">
          <div class="w-6 h-6 rounded-full bg-accent text-base-100 flex items-center justify-center text-xs font-bold">1</div>
          <span class="text-xs font-medium hidden sm:block">{t('contact.wizard.steps.topic')}</span>
        </div>
        <div class="w-8 h-px bg-base-content/10 contact-minimal-connector"></div>
        <div class="contact-minimal-step flex items-center gap-2 text-base-content/80" data-step="2">
          <div class="w-6 h-6 rounded-full bg-base-content/10 flex items-center justify-center text-xs font-bold">2</div>
          <span class="text-xs font-medium hidden sm:block">{t('contact.wizard.steps.details')}</span>
        </div>
        <div class="w-8 h-px bg-base-content/10 contact-minimal-connector"></div>
        <div class="contact-minimal-step flex items-center gap-2 text-base-content/80" data-step="3">
          <div class="w-6 h-6 rounded-full bg-base-content/10 flex items-center justify-center text-xs font-bold">3</div>
          <span class="text-xs font-medium hidden sm:block">{t('contact.wizard.steps.send')}</span>
        </div>
      </div>

      <!-- Step 1: Intent Selection -->
      <div class="contact-minimal-panel" data-panel="1">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
          {intents.map(intent => (
            <button 
              class="contact-minimal-intent group p-5 sm:p-6 rounded-xl sm:rounded-2xl bg-base-content/[0.02] border border-base-content/10 text-left hover:bg-accent/5 hover:border-accent/30 transition-all duration-500"
              data-intent={intent.id}
            >
              <div class="flex items-start gap-4">
                <span class="text-2xl sm:text-3xl group-hover:scale-110 transition-transform duration-500">{intent.icon}</span>
                <div>
                  <p class="text-sm sm:text-base font-bold text-base-content">{intent.label}</p>
                  <p class="text-xs text-base-content/75 mt-0.5">{intent.desc}</p>
                </div>
              </div>
            </button>
          ))}
        </div>
      </div>

      <!-- Step 2: Dynamic Fields (hidden initially) -->
      <div class="contact-minimal-panel hidden" data-panel="2">
        <div class="p-6 sm:p-8 rounded-2xl bg-base-content/[0.02] border border-base-content/10">
          
          <!-- Intent badge -->
          <div class="flex items-center gap-2 mb-6">
            <span class="contact-minimal-intent-icon text-xl">üíº</span>
            <span class="contact-minimal-intent-label text-sm font-bold text-base-content">{t('contact.intents.sales')}</span>
            <button class="contact-minimal-change-intent ml-auto text-xs text-accent hover:underline">{t('contact.wizard.actions.change')}</button>
          </div>

          <!-- Dynamic form fields container -->
          <div class="contact-minimal-fields space-y-4">
            <!-- Fields will be injected based on intent -->
          </div>

          <!-- Continue button -->
          <button class="contact-minimal-continue w-full mt-6 px-6 py-4 rounded-xl bg-accent text-base-100 font-bold text-sm flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300">
            <span>{t('contact.wizard.actions.continue')}</span>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Step 3: Contact Info & Message (hidden initially) -->
      <div class="contact-minimal-panel hidden" data-panel="3">
        <div class="p-6 sm:p-8 rounded-2xl bg-base-content/[0.02] border border-base-content/10">
          <form class="contact-minimal-form space-y-4" novalidate>
            <!-- Name -->
            <div class="form-control">
              <label class="block text-xs font-bold text-base-content/75 uppercase tracking-wider mb-2">{t('contact.form.name')}</label>
              <input 
                type="text" 
                name="name"
                required
                class="w-full px-4 py-3.5 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/40 transition-all duration-300"
                placeholder={t('contact.placeholders.johnSmith')}
              />
            </div>

            <!-- Email -->
            <div class="form-control">
              <label class="block text-xs font-bold text-base-content/75 uppercase tracking-wider mb-2">{t('contact.form.email')}</label>
              <input 
                type="email" 
                name="email"
                required
                inputmode="email"
                class="w-full px-4 py-3.5 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/40 transition-all duration-300"
                placeholder={t('contact.placeholders.yourEmail')}
              />
            </div>

            <!-- Message -->
            <div class="form-control">
              <label class="block text-xs font-bold text-base-content/75 uppercase tracking-wider mb-2">{t('contact.form.message')}</label>
              <textarea 
                name="message"
                required
                rows="4"
                class="w-full px-4 py-3.5 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/40 transition-all duration-300 resize-none"
                placeholder={t('contact.placeholders.tellUs')}
              ></textarea>
            </div>

            <!-- Submit -->
            <button 
              type="submit"
              class="contact-minimal-submit w-full px-6 py-4 rounded-xl bg-accent text-base-100 font-bold text-sm flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300"
            >
              <span>{t('contact.form.send')}</span>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </form>

          <!-- Back link -->
          <button class="contact-minimal-back w-full mt-4 text-xs text-base-content/75 hover:text-accent transition-colors">
            {t('contact.wizard.actions.back')}
          </button>
        </div>
      </div>

      <!-- Success Panel (hidden) -->
      <div class="contact-minimal-panel hidden" data-panel="success">
        <div class="p-8 sm:p-12 rounded-2xl bg-accent/5 border border-accent/20 text-center">
          <div class="text-5xl mb-4">üéâ</div>
          <h3 class="text-xl font-bold text-base-content mb-2">{t('contact.successTitle')}</h3>
          <p class="text-sm text-base-content/75 mb-6" id="contact-minimal-success-text"></p>
          <button class="contact-minimal-restart text-sm text-accent hover:underline">
            {t('contact.wizard.actions.restart')}
          </button>
        </div>
      </div>
    </div>
  </div>
</section>


<script>
  import { safeParse } from 'valibot';
  import { createContactSchema } from '../../../lib/schemas/contact';
  import { validateForm } from '../../../utils/form-validation';

  let contactMinimalController: AbortController | null = null;

  function initContactMinimal() {
    // Abort previous listeners
    contactMinimalController?.abort();
    contactMinimalController = new AbortController();
    const signal = contactMinimalController.signal;

    const wizard = document.querySelector('.contact-minimal-wizard') as HTMLElement;
    if (!wizard) return;

    const i18n = JSON.parse(wizard.dataset.i18n || '{}');
    const validationMessages = JSON.parse(wizard.dataset.validationMessages || '{}');
    const t = (key: string) => validationMessages[key.split('.')[1]] || key;
    const schema = createContactSchema(t);

    const panels = wizard.querySelectorAll('.contact-minimal-panel');
    const steps = wizard.querySelectorAll('.contact-minimal-step');
    const connectors = wizard.querySelectorAll('.contact-minimal-connector');

    let currentStep = 1;
    let selectedIntent = '';
    let formData: Record<string, string> = {};

    const intentFields: Record<string, { label: string; type: string; placeholder: string; name: string }[]> = {
      sales: [
        { label: i18n.fields.companyName, type: 'text', placeholder: i18n.placeholders.acme, name: 'company' },
        { label: i18n.fields.teamSize, type: 'select', placeholder: i18n.placeholders.teamSize, name: 'team_size' },
        { label: i18n.fields.budget, type: 'select', placeholder: i18n.placeholders.budget, name: 'budget' },
      ],
      support: [
        { label: i18n.fields.issueType, type: 'select', placeholder: i18n.placeholders.issueType, name: 'issue_type' },
        { label: i18n.fields.severity, type: 'select', placeholder: i18n.placeholders.severity, name: 'severity' },
        { label: i18n.fields.accountEmail, type: 'email', placeholder: i18n.placeholders.accountEmail, name: 'account_email' },
      ],
      partnership: [
        { label: i18n.fields.companyName, type: 'text', placeholder: i18n.placeholders.partnerCorp, name: 'company' },
        { label: i18n.fields.yourRole, type: 'text', placeholder: i18n.placeholders.role, name: 'role' },
        { label: i18n.fields.partnershipType, type: 'select', placeholder: i18n.placeholders.partnershipType, name: 'partnership_type' },
      ],
      other: [
        { label: i18n.fields.topic, type: 'text', placeholder: i18n.placeholders.topic, name: 'topic' },
      ],
    };

    // Note: step 2 dynamic fields use custom validation logic since they aren't fully in schema

    // Step 2 Validation (Dynamic Fields)
    function validateStep2(): boolean {
       // For these dynamic fields, we check simple required presence if they are selects,
       // or if they match schema keys (like company).
       // The shared schema handles 'company' and 'topic'. Others like 'budget' are optional in schema 
       // but maybe required in UI. Let's enforce required just for basic validity.
       
       const container = wizard.querySelector('.contact-minimal-fields');
       if (!container) return true;
       const inputs = container.querySelectorAll('input, select') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
       let valid = true;
       
       inputs.forEach(input => {
          // Check if empty
           if (!input.value) {
            valid = false;
            input.classList.add('input-error');
            const parent = input.closest('div');
            parent?.querySelector('.error-message')?.remove();
            const errorMsg = document.createElement('p');
            errorMsg.className = 'error-message';
            errorMsg.innerHTML = `<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> ${validationMessages?.required || 'Required'}`;
            parent?.appendChild(errorMsg);
          } else {
            input.classList.remove('input-error');
            input.closest('div')?.querySelector('.error-message')?.remove();
          }
       });

       return valid;
    }

    function showPanel(panelNum: number | string) {
      panels.forEach(p => {
        p.classList.add('hidden');
        if (p.getAttribute('data-panel') === String(panelNum)) {
          p.classList.remove('hidden');
        }
      });

      // Update step indicators
      steps.forEach((step, i) => {
        const stepNum = i + 1;
        step.classList.remove('active', 'completed');
        
        if (typeof panelNum === 'number') {
          if (stepNum < panelNum) {
            step.classList.add('completed');
          } else if (stepNum === panelNum) {
            step.classList.add('active');
          }
        }
      });

      connectors.forEach((conn, i) => {
        conn.classList.toggle('active', typeof panelNum === 'number' && i < panelNum - 1);
      });
    }

    function buildFields(intent: string) {
      const container = wizard.querySelector('.contact-minimal-fields');
      if (!container) return;

      const fields = intentFields[intent] || intentFields.other;
      container.innerHTML = '';

      fields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
          <label class="block text-xs font-bold text-base-content/75 uppercase tracking-wider mb-2">${field.label}</label>
          ${field.type === 'select' ? `
            <select name="${field.name}" class="w-full px-4 py-3.5 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content focus:outline-none focus:border-accent/40 transition-all duration-300">
              <option value="">${i18n.placeholders.select}</option>
              ${field.placeholder.split('|').map(opt => `<option value="${opt.toLowerCase()}">${opt}</option>`).join('')}
            </select>
          ` : `
            <input 
              type="${field.type}" 
              name="${field.name}"
              class="w-full px-4 py-3.5 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/40 transition-all duration-300"
              placeholder="${field.placeholder}"
              ${field.type === 'email' ? 'inputmode="email"' : ''}
            />
          `}
        `;
        container.appendChild(div);
      });
    }

    // Intent selection
    wizard.querySelectorAll('.contact-minimal-intent').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedIntent = (btn as HTMLElement).dataset.intent || '';
        formData['intent'] = selectedIntent;

        // Update intent badge
        const intents = JSON.parse(wizard.dataset.intents || '[]');
        const selected = intents.find((i: any) => i.id === selectedIntent);
        if (selected) {
          const iconEl = wizard.querySelector('.contact-minimal-intent-icon');
          const labelEl = wizard.querySelector('.contact-minimal-intent-label');
          if (iconEl) iconEl.textContent = selected.icon;
          if (labelEl) labelEl.textContent = selected.label;
        }

        buildFields(selectedIntent);
        currentStep = 2;
        showPanel(2);
      }, { signal });
    });

    // Change intent
    wizard.querySelector('.contact-minimal-change-intent')?.addEventListener('click', () => {
      currentStep = 1;
      showPanel(1);
    }, { signal });

    // Continue to step 3
    wizard.querySelector('.contact-minimal-continue')?.addEventListener('click', () => {
      // Validate Step 2
      if (!validateStep2()) {
         // Shake
         const panel = wizard.querySelector('[data-panel="2"] .rounded-2xl');
         panel?.classList.add('animate-shake');
         setTimeout(()=>panel?.classList.remove('animate-shake'), 300);
         return;
      }

      // Gather step 2 data
      const fields = wizard.querySelectorAll('.contact-minimal-fields input, .contact-minimal-fields select');
      fields.forEach(field => {
        const name = (field as HTMLInputElement).name;
        const value = (field as HTMLInputElement).value;
        if (name && value) formData[name] = value;
      });

      currentStep = 3;
      showPanel(3);
    }, { signal });

    // Back to step 2
    wizard.querySelector('.contact-minimal-back')?.addEventListener('click', () => {
      currentStep = 2;
      showPanel(2);
    }, { signal });

    // Form submission
    const form = wizard.querySelector('.contact-minimal-form');
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formDataObj = new FormData(form as HTMLFormElement);
      const data: Record<string, any> = { ...formData }; // Start with existing data
      formDataObj.forEach((value, key) => {
        data[key] = value as string;
      });

      const result = validateForm({ form: form as HTMLFormElement, schema });
      
      if (!result.success) {
        return;
      }
      
      // Merge step 2 data back into final data
      const finalData = { ...formData, ...(result.data || {}) };


      // Update success message text
      const teamNames: Record<string, string> = i18n.teams;
      const teamName = teamNames[selectedIntent] || teamNames.default;
      const successTextEl = document.getElementById('contact-minimal-success-text');
      if (successTextEl) {
        successTextEl.textContent = i18n.successMsg.replace('{team}', teamName);
      }

      showPanel('success');
    }, { signal });

    // Restart
    wizard.querySelector('.contact-minimal-restart')?.addEventListener('click', () => {
      formData = {};
      selectedIntent = '';
      currentStep = 1;
      // Reset forms
      (form as HTMLFormElement).reset();
      form?.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      form?.querySelectorAll('.error-message').forEach(el => el.remove());
      showPanel(1);
    }, { signal });

    // Initialize
    showPanel(1);
  }

  initContactMinimal();
  document.addEventListener('astro:after-swap', initContactMinimal);
</script>

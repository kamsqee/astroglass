---
/**
 * Contact Luxury - The Glass Form
 * Sophisticated contact interface with validation.
 * Mobile: Full width. Desktop: Split screen with info.
 */
import '../../../styles/components/contact/ContactLuxury.css';
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';
import LuxuryButton from '../../ui/luxury/LuxuryButton.astro';
import LuxuryCard from '../../ui/luxury/LuxuryCard.astro';
import LuxurySectionLabel from '../../ui/luxury/LuxurySectionLabel.astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

// Validation config
const validationMessages = {
  nameShort: t('contact.validation.nameShort'),
  nameLong: t('contact.validation.nameLong'),
  emailInvalid: t('contact.validation.emailInvalid'),
  messageShort: t('contact.validation.messageShort'),
  messageLong: t('contact.validation.messageLong'),
  required: t('contact.validation.required'),
  submitError: t('contact.validation.submitError'),
  sending: t('contact.form.sending'),
};
---

<section class="relative py-20 lg:py-32 px-4 sm:px-6 lg:px-8 overflow-hidden bg-base-100" id="contact">
  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-16 lg:gap-24 items-center">
    
    <!-- Info Column -->
    <div class="w-full lg:w-1/2 text-center lg:text-left">
       <div class="flex justify-center lg:justify-start mb-6">
         <LuxurySectionLabel text={t('contact.eyebrow')} />
       </div>
       <h2 class="text-4xl md:text-5xl lg:text-7xl font-normal font-serif text-base-content tracking-tighter mb-8 leading-none">
          {t('contact.title')}
       </h2>
       <p class="text-lg text-base-content/75 leading-relaxed mb-12 max-w-lg mx-auto lg:mx-0">
          {t('contact.subtitle')}
       </p>

       <div class="space-y-8 hidden lg:block">
          <div class="flex items-center gap-6 group">
             <div class="w-14 h-14 rounded-full bg-accent/5 flex items-center justify-center border border-accent/10 group-hover:scale-110 transition-luxury">
                <span class="text-2xl">üìß</span>
             </div>
             <div>
                <p class="text-xs font-bold uppercase tracking-widest text-base-content/75 mb-1">{t('contact.emailLabel')}</p>
                <a href="mailto:hello@liquid.com" class="text-xl font-medium text-base-content hover:text-accent transition-colors">hello@liquid.com</a>
             </div>
          </div>

          <div class="flex items-center gap-6 group">
             <div class="w-14 h-14 rounded-full bg-accent/5 flex items-center justify-center border border-accent/10 group-hover:scale-110 transition-luxury">
                <span class="text-2xl">üìç</span>
             </div>
             <div>
                <p class="text-xs font-bold uppercase tracking-widest text-base-content/75 mb-1">{t('contact.officeLabel')}</p>
                <p class="text-xl font-medium text-base-content">{t('contact.officeLocation')}</p>
             </div>
          </div>
       </div>
    </div>

    <div class="w-full lg:w-1/2">
       <LuxuryCard class="contact-luxury-form-container p-8 md:p-12 relative flex flex-col gap-6" data-validation-messages={JSON.stringify(validationMessages)} hover={false}>
          <form class="contact-luxury-form relative z-10" id="contact-form" novalidate>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                <!-- Name Field -->
                <div class="input-group">
                   <label for="name" class="text-xs font-bold uppercase tracking-widest text-base-content/75 ml-1">{t('contact.name')}</label>
                   <input 
                     type="text" 
                     id="name" 
                     name="name"
                     class="w-full bg-base-content/5 border border-base-content/10 rounded-xl px-6 py-4 text-base-content placeholder:text-base-content/75 focus:outline-none transition-luxury"
                     placeholder={t('contact.placeholders.johnSmith')}
                   />
                   <div class="field-footer"></div>
                </div>

                <!-- Email Field -->
                <div class="input-group">
                   <label for="email" class="text-xs font-bold uppercase tracking-widest text-base-content/75 ml-1">{t('contact.email')}</label>
                   <input 
                     type="email" 
                     id="email" 
                     name="email"
                     class="w-full bg-base-content/5 border border-base-content/10 rounded-xl px-6 py-4 text-base-content placeholder:text-base-content/75 focus:outline-none transition-luxury"
                     placeholder={t('contact.placeholders.yourEmail')}
                   />
                   <div class="field-footer"></div>
                </div>
             </div>

             <!-- Scale Field -->
             <div class="input-group">
                <label for="scale" class="text-xs font-bold uppercase tracking-widest text-base-content/75 ml-1">{t('contact.scaleLabel')}</label>
                <div class="relative">
                   <select id="scale" name="scale" class="w-full bg-base-content/5 border border-base-content/10 rounded-xl px-6 py-4 text-base-content focus:outline-none transition-luxury appearance-none">
                      <option value="sm">{t('contact.scale.sm')}</option>
                      <option value="md">{t('contact.scale.md')}</option>
                      <option value="lg">{t('contact.scale.lg')}</option>
                      <option value="xl">{t('contact.scale.xl')}</option>
                   </select>
                   <div class="absolute right-4 top-1/2 -translate-y-1/2 text-base-content/75 pointer-events-none">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                   </div>
                </div>
                <div class="field-footer"></div>
             </div>

             <!-- Message Field -->
             <div class="input-group">
                <label for="message" class="text-xs font-bold uppercase tracking-widest text-base-content/75 ml-1">{t('contact.message')}</label>
                <textarea 
                  id="message" 
                  name="message"
                  class="w-full bg-base-content/5 border border-base-content/10 rounded-xl px-6 py-4 text-base-content placeholder:text-base-content/75 focus:outline-none transition-luxury resize-none"
                  placeholder={t('contact.messagePlaceholder')}
                ></textarea>
                <div class="field-footer"></div>
             </div>

             <div class="pt-2">
               <LuxuryButton type="submit" variant="primary" class="w-full" icon={true}>
                  <span id="btn-text">{t('contact.send')}</span>
               </LuxuryButton>
             </div>
          </form>

          <!-- Success State -->
          <div class="contact-luxury-success hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 md:p-12 z-20 transition-all duration-500">
            <h3 class="text-3xl font-serif tracking-tight text-base-content mb-4 opacity-0 translate-y-4 transition-all duration-700 delay-100 ease-out" id="success-title">{t('contact.successTitleLuxury')}</h3>
            <p class="text-base text-base-content/75 mb-8 opacity-0 translate-y-4 transition-all duration-700 delay-200 ease-out" id="success-desc">{t('contact.successDescLuxury')}</p>
            
            <div class="opacity-0 translate-y-4 transition-all duration-700 delay-300 ease-out" id="success-btn-container">
               <LuxuryButton type="button" variant="secondary" class="contact-reset-btn">
                  {t('contact.wizard.actions.restart')}
               </LuxuryButton>
            </div>
          </div>

       </LuxuryCard>
    </div>

  </div>
</section>

<script>
  import { createContactSchema } from '../../../lib/schemas/contact';
  import { validateSingleField, validateForm } from '../../../utils/form-validation';

  let contactLuxuryController: AbortController | null = null;

  function initContactLuxury() {
    contactLuxuryController?.abort();
    contactLuxuryController = new AbortController();
    const signal = contactLuxuryController.signal;

    const container = document.querySelector('.contact-luxury-form-container') as HTMLElement;
    if (!container) return;

    const form = container.querySelector('form') as HTMLFormElement;
    if (!form) return;

    const success = container.querySelector('.contact-luxury-success') as HTMLElement;
    const successTitle = success.querySelector('#success-title') as HTMLElement;
    const successDesc = success.querySelector('#success-desc') as HTMLElement;
    const successBtnContainer = success.querySelector('#success-btn-container') as HTMLElement;
    const resetBtn = container.querySelector('.contact-reset-btn');

    const validationMessages = JSON.parse(container.dataset.validationMessages || '{}');
    const t = (key: string) => validationMessages[key.split('.').pop() || ''] || key;
    const schema = createContactSchema(t);

    const setFieldError = (input: Element, message: string | null) => {
        const group = input.closest('.input-group');
        const footer = group?.querySelector('.field-footer');
        if (!footer) return;

        if (message) {
            input.classList.add('input-error');
            footer.textContent = message;
            footer.classList.add('has-error');
        } else {
            input.classList.remove('input-error');
            footer.textContent = '';
            footer.classList.remove('has-error');
        }
    };

    const renderError = (input: HTMLElement, message: string) => setFieldError(input, message);
    const clearError = (input: HTMLElement) => setFieldError(input, null);

    const validateFieldWrapper = (input: HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement) => {
       validateSingleField(input, { form, schema, renderError, clearError });
    };

    // Attach listeners
    form.querySelectorAll('input, textarea, select').forEach(input => {
      const el = input as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
      
      // On Blur: Validate
      el.addEventListener('blur', () => {
          validateFieldWrapper(el);
      }, { signal });

      // On Input: Clear Error (Lazy Validation)
      el.addEventListener('input', () => {
         setFieldError(el, null);
      }, { signal });
    });

    // Handle Submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const btnText = btn.querySelector('#btn-text') as HTMLElement;
      
      const formData = new FormData(form);
      const data: Record<string, any> = {};
      formData.forEach((value, key) => data[key] = value);

      const result = validateForm({ form, schema, renderError, clearError });

      if (!result.success) {
        return;
      }

      // Submit Loading State
      const originalText = btnText.textContent;
      btnText.textContent = t('sending'); // Text Morphing
      form.classList.add('state-readonly'); // Readonly form
      const inputs = form.querySelectorAll('input, textarea, select, button');
      inputs.forEach(el => (el as HTMLInputElement).disabled = true); // Strict disable

      // Simulate Network Request
      await new Promise(resolve => setTimeout(resolve, 1500));

      
      // Initial success feedback on button
      btnText.textContent = "Sent!";
      
      // Delay before fading out form to let user see "Sent!"
      setTimeout(() => {
          // Transition to Success
          form.style.opacity = '0';
          form.style.pointerEvents = 'none';

          // Wait for form fade out
          setTimeout(() => {
            form.style.visibility = 'hidden'; // Keeps layout space
            success.classList.remove('hidden');
            
            // Micro-interaction: Reveal content
            setTimeout(() => {
                successTitle.classList.remove('opacity-0', 'translate-y-4');
                successDesc.classList.remove('opacity-0', 'translate-y-4');
                successBtnContainer.classList.remove('opacity-0', 'translate-y-4');
            }, 50); 
          }, 500); // Match opacity transition duration
      }, 700);


      // Reset button state (in background)
      setTimeout(() => {
        btnText.textContent = originalText;
        form.classList.remove('state-readonly');
        inputs.forEach(el => (el as HTMLInputElement).disabled = false);
      }, 2000);
    }, { signal });

    // Handle Reset
    resetBtn?.addEventListener('click', () => {
       form.reset();
       // Reset Visuals
       success.classList.add('hidden');
       successTitle.classList.add('opacity-0', 'translate-y-4');
       successDesc.classList.add('opacity-0', 'translate-y-4');
       successBtnContainer.classList.add('opacity-0', 'translate-y-4');
       
       form.style.visibility = 'visible';
       form.classList.remove('hidden');
       // Fade in form
       requestAnimationFrame(() => {
          form.style.opacity = '1';
          form.style.pointerEvents = 'auto';
       });

       form.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
       form.querySelectorAll('.field-footer').forEach(el => {
           el.textContent = '';
           el.classList.remove('has-error');
       });
    }, { signal });
  }

  initContactLuxury();
  document.addEventListener('astro:after-swap', initContactLuxury);
</script>




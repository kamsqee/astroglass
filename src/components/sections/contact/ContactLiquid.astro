---
/**
 * Contact Liquid - The Conversation Thread (REMARKABLE)
 * Chat-style form with typing indicators, quick-reply chips.
 * Feels like texting, not filling forms.
 */
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

  const validationMessages = {
    emailInvalid: t('contact.validation.emailInvalid'),
    required: t('contact.validation.required')
  };

  const chatData = JSON.stringify({
    askName: t('contact.chat.askName'),
    askEmail: t('contact.chat.askEmail'),
    askMessage: t('contact.chat.askMessage'),
    thanks: t('contact.chat.thanks')
  });
import '../../../styles/components/contact/ContactLiquid.css';
import LiquidSectionTag from '../../ui/liquid/LiquidSectionTag.astro';
---

<section id="contact" class="relative py-16 lg:py-24 px-4 sm:px-6 overflow-hidden bg-base-100">
  <!-- Background -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute top-1/4 left-1/2 -translate-x-1/2 w-[500px] h-[500px] bg-accent/5 rounded-full blur-[150px]"></div>
  </div>

  <div class="max-w-lg mx-auto relative">
    <!-- Header -->
    <div class="text-center mb-6 sm:mb-8">
      <LiquidSectionTag label={t('contact.eyebrow')} class="mb-4" />
      <h2 class="text-2xl sm:text-3xl font-black text-base-content tracking-tight">{t('contact.title')}</h2>
    </div>

    <!-- Chat Container -->
    <div class="contact-liquid-chat relative bg-base-content/[0.02] border border-base-content/10 rounded-2xl sm:rounded-3xl overflow-hidden backdrop-blur-sm" data-chat={chatData} data-validation-messages={JSON.stringify(validationMessages)}>
      
      <!-- Chat Header -->
      <div class="flex items-center gap-3 px-4 sm:px-6 py-3 sm:py-4 bg-base-content/[0.03] border-b border-base-content/5">
        <div class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center text-lg">üí¨</div>
        <div>
          <p class="text-sm font-bold text-base-content">{t('contact.supportTeam')}</p>
          <p class="text-xs text-base-content/75 flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></span>
            {t('contact.onlineNow')}
          </p>
        </div>
      </div>

      <!-- Messages Container -->
      <div class="contact-liquid-messages p-4 sm:p-6 space-y-4 min-h-[300px] max-h-[400px] overflow-y-auto">
        <!-- Initial bot message -->
        <div class="contact-liquid-msg bot flex gap-3">
          <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center text-sm shrink-0">üí¨</div>
          <div class="bg-base-content/[0.05] rounded-2xl rounded-tl-md px-4 py-3 max-w-[85%]">
            <p class="text-sm text-base-content">{t('contact.botWelcome')}</p>
          </div>
        </div>
      </div>

      <!-- Quick Replies / Input Area -->
      <div class="contact-liquid-input-area border-t border-base-content/5 p-4 sm:p-5 bg-base-content/[0.02]">
        <!-- Quick Reply Chips (Step 0) -->
        <div class="contact-liquid-chips flex flex-wrap gap-2" data-step="0">
          <button class="contact-liquid-chip px-4 py-2 rounded-full bg-accent/10 border border-accent/20 text-sm font-medium text-accent hover:bg-accent hover:text-base-100 transition-all duration-500" data-value="sales">
            üíº {t('contact.intents.sales')}
          </button>
          <button class="contact-liquid-chip px-4 py-2 rounded-full bg-base-content/5 border border-base-content/10 text-sm font-medium text-base-content/70 hover:bg-base-content/10 transition-all duration-500" data-value="support">
            üõ† {t('contact.intents.support')}
          </button>
          <button class="contact-liquid-chip px-4 py-2 rounded-full bg-base-content/5 border border-base-content/10 text-sm font-medium text-base-content/70 hover:bg-base-content/10 transition-all duration-500" data-value="partnership">
            ü§ù {t('contact.intents.partnership')}
          </button>
          <button class="contact-liquid-chip px-4 py-2 rounded-full bg-base-content/5 border border-base-content/10 text-sm font-medium text-base-content/70 hover:bg-base-content/10 transition-all duration-500" data-value="other">
            üí≠ {t('contact.intents.other')}
          </button>
        </div>

        <!-- Text Input (hidden initially) -->
        <div class="contact-liquid-text-input hidden">
          <div class="flex gap-3 relative">
            <input 
              type="text" 
              class="contact-liquid-input flex-1 px-4 py-3 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/30 transition-all duration-300"
              placeholder={t('contact.placeholders.typeMessage')}
            />
            <button class="contact-liquid-send w-12 h-12 rounded-xl bg-accent text-base-100 flex items-center justify-center hover:scale-105 active:scale-95 transition-all duration-300">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Email Input (hidden) -->
        <div class="contact-liquid-email-input hidden">
          <div class="flex gap-3 relative">
            <input 
              type="email" 
              class="contact-liquid-input flex-1 px-4 py-3 rounded-xl bg-base-content/[0.03] border border-base-content/10 text-sm text-base-content placeholder:text-base-content/80 focus:outline-none focus:border-accent/30 transition-all duration-300"
              placeholder={t('contact.placeholders.yourEmail')}
              inputmode="email"
            />
            <button class="contact-liquid-send-email w-12 h-12 rounded-xl bg-accent text-base-100 flex items-center justify-center hover:scale-105 active:scale-95 transition-all duration-300">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Success State (hidden) -->
        <div class="contact-liquid-success hidden text-center py-4">
          <div class="text-3xl mb-2">‚ú®</div>
          <p class="text-sm text-base-content/75">{t('contact.messageSent')}</p>
        </div>
      </div>
    </div>

    <!-- Trust line -->
    <p class="text-center text-xs text-base-content/80 mt-4">
      {t('contact.secureInfo')}
    </p>
  </div>
</section>

</style>

<script>
  import { safeParse, email, string, pipe } from 'valibot';
  
  let contactLiquidController: AbortController | null = null;

  function initContactLiquid() {
    // Abort previous listeners
    contactLiquidController?.abort();
    contactLiquidController = new AbortController();
    const signal = contactLiquidController.signal;

    const chat = document.querySelector('.contact-liquid-chat') as HTMLElement;
    if (!chat) return;

    const chatData = chat.dataset.chat ? JSON.parse(chat.dataset.chat) : {};
    const validationMessages = JSON.parse(chat.dataset.validationMessages || '{}');

    const messages = chat.querySelector('.contact-liquid-messages');
    const chipsContainer = chat.querySelector('.contact-liquid-chips');
    const textInputContainer = chat.querySelector('.contact-liquid-text-input');
    const emailInputContainer = chat.querySelector('.contact-liquid-email-input');
    const successContainer = chat.querySelector('.contact-liquid-success');

    let step = 0;
    let formData: Record<string, string> = {};

    const questions = [
      { key: 'intent', botMsg: null },
      { key: 'name', botMsg: chatData.askName || "Nice! What's your name?" },
      { key: 'email', botMsg: chatData.askEmail || "Great to meet you! What's the best email?" },
      { key: 'message', botMsg: chatData.askMessage || "Perfect! Now tell me what you need help with." },
    ];

    function showError(input: HTMLInputElement, message?: string) {
       input.classList.add('input-error');
       input.parentElement?.classList.add('animate-shake');
       setTimeout(() => input.parentElement?.classList.remove('animate-shake'), 300);
       // Optional: Show toast or bot message?
       // For chat, user expects bot to say it using chat bubble, but that interrupts flow.
       // Red border + shake is enough feedback for "wrong format".
    }

    function clearError(input: HTMLInputElement) {
       input.classList.remove('input-error');
    }

    function addMessage(text: string, isUser: boolean) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `contact-liquid-msg ${isUser ? 'user' : 'bot'} flex gap-3`;
      
      if (isUser) {
        msgDiv.innerHTML = `
          <div class="bg-accent text-base-100 rounded-2xl rounded-tr-md px-4 py-3 max-w-[85%] ml-auto">
            <p class="text-sm">${text}</p>
          </div>
        `;
      } else {
        msgDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center text-sm shrink-0">üí¨</div>
          <div class="bg-base-content/[0.05] rounded-2xl rounded-tl-md px-4 py-3 max-w-[85%]">
            <p class="text-sm text-base-content">${text}</p>
          </div>
        `;
      }
      
      messages?.appendChild(msgDiv);
      messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }

    function showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'contact-liquid-msg bot flex gap-3 typing-indicator';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center text-sm shrink-0">üí¨</div>
        <div class="bg-base-content/[0.05] rounded-2xl rounded-tl-md">
          <div class="contact-liquid-typing">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;
      messages?.appendChild(typingDiv);
      messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }

    function hideTyping() {
      const typing = messages?.querySelector('.typing-indicator');
      typing?.remove();
    }

    function nextStep() {
      step++;
      if (step >= questions.length) {
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage(chatData.thanks || "Thanks! We'll get back to you soon.", false);
          textInputContainer?.classList.add('hidden');
          emailInputContainer?.classList.add('hidden');
          successContainer?.classList.remove('hidden');
        }, 1000);
        return;
      }

      const q = questions[step];
      let msg = q.botMsg || '';
      Object.keys(formData).forEach(key => {
        msg = msg.replace(`{${key}}`, formData[key]);
      });

      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage(msg, false);

        chipsContainer?.classList.add('hidden');
        if (q.key === 'email') {
          textInputContainer?.classList.add('hidden');
          emailInputContainer?.classList.remove('hidden');
          (emailInputContainer?.querySelector('input') as HTMLInputElement)?.focus();
        } else {
          emailInputContainer?.classList.add('hidden');
          textInputContainer?.classList.remove('hidden');
          (textInputContainer?.querySelector('input') as HTMLInputElement)?.focus();
        }
      }, 800);
    }

    // Chip click handler
    chipsContainer?.querySelectorAll('.contact-liquid-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const value = (chip as HTMLElement).dataset.value || '';
        const label = chip.textContent?.trim() || value;
        formData['intent'] = value;
        addMessage(label, true);
        nextStep();
      }, { signal });
    });

    // Text input handler
    const textInput = textInputContainer?.querySelector('input');
    const textSend = textInputContainer?.querySelector('.contact-liquid-send');
    
    function submitText() {
      const value = textInput?.value.trim();
      if (!value) {
         showError(textInput as HTMLInputElement);
         return;
      }
      clearError(textInput as HTMLInputElement);
      
      formData[questions[step].key] = value;
      addMessage(value, true);
      if (textInput) textInput.value = '';
      nextStep();
    }

    textSend?.addEventListener('click', submitText, { signal });
    textInput?.addEventListener('keydown', (e) => {
      clearError(textInput as HTMLInputElement);
      if (e.key === 'Enter') submitText();
    }, { signal });

    // Email input handler
    const emailInput = emailInputContainer?.querySelector('input');
    const emailSend = emailInputContainer?.querySelector('.contact-liquid-send-email');
    
    function submitEmail() {
      const value = emailInput?.value.trim();
      
      // Valibot Email Check
      const EmailSchema = pipe(string(), email());
      const result = safeParse(EmailSchema, value || '');
      
      if (!value || !result.success) {
         showError(emailInput as HTMLInputElement);
         return;
      }
      clearError(emailInput as HTMLInputElement);
      
      formData['email'] = value;
      addMessage(value, true);
      if (emailInput) emailInput.value = '';
      nextStep();
    }

    emailSend?.addEventListener('click', submitEmail, { signal });
    emailInput?.addEventListener('keydown', (e) => {
      clearError(emailInput as HTMLInputElement);
      if (e.key === 'Enter') submitEmail();
    }, { signal });
  }

  initContactLiquid();
  document.addEventListener('astro:after-swap', initContactLiquid);
</script>

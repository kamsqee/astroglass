---
/**
 * HeaderGlass — Floating Glass Bar
 *
 * Responsive header with glass morphism, dropdown navigation, and mobile panel.
 * Desktop: floating glass bar with inline nav + dropdowns.
 * Mobile: fullscreen slide-up panel with accordions.
 */
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';
import LocalizedLink from '../../ui/LocalizedLink.astro';
import { buildThemeNavLinks } from '../../../config/navigation';
import LanguageSwitcher from '../../ui/LanguageSwitcher.astro';
import ThemeSwitcher from '../../ui/ThemeSwitcher.astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const navLinks = buildThemeNavLinks(t, 'glass');
import '../../../styles/components/header/HeaderGlass.css';
import '../../../styles/components/header/NavOverflow.css';

const moreLabel = t('nav.more', { silent: true }) || 'More';
---

<header class="header-glass">
  <div class="header-glass-container">
    <div class="header-glass-inner">
      <LocalizedLink href="/" class="logo-glass" aria-label={t('siteName')}>
        <span class="logo-glass-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2.5C12 2.5 4 10 4 14.5C4 18.92 7.58 22.5 12 22.5C16.42 22.5 20 18.92 20 14.5C20 10 12 2.5 12 2.5Z"/>
            <path d="M8.5 14L12 8L15.5 14L12 18Z"/>
          </svg>
        </span>
        <span class="logo-glass-text">{t('siteName')}</span>
      </LocalizedLink>

      <nav class="nav-glass">
        {navLinks.map((link) => (
          link.children ? (
            <div class="dropdown-glass" data-dropdown-glass>
              <button 
                type="button"
                class="nav-glass-item" 
                aria-expanded="false"
              >
                {link.label}
                <svg class="nav-glass-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="dropdown-glass-menu">
                {link.children.map((child) => (
                  <LocalizedLink href={child.href} class="dropdown-glass-item">
                    {child.label}
                  </LocalizedLink>
                ))}
              </div>
            </div>
          ) : (
            <LocalizedLink href={link.href} class="nav-glass-item">
              {link.label}
            </LocalizedLink>
          )
        ))}

        {/* Overflow "More" dropdown — hidden by default, shown by JS */}
        <div class="dropdown-glass" data-nav-more>
          <button type="button" class="nav-glass-item nav-more-trigger" aria-expanded="false">
            {moreLabel}
            <svg class="nav-glass-chevron nav-more-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="dropdown-glass-menu nav-more-menu" data-nav-more-menu></div>
        </div>
      </nav>

      <div class="header-glass-actions">
        <ThemeSwitcher />
        <LanguageSwitcher />
      </div>

      <div class="header-glass-mobile-actions">
        <button type="button" class="burger-glass" id="burger-glass" aria-label={t('nav.openMenu')}>
          <span class="burger-glass-line"></span>
          <span class="burger-glass-line"></span>
        </button>
      </div>
    </div>
  </div>
</header>

<div class="panel-glass" id="panel-glass">
  <div class="panel-glass-content">
    <nav class="panel-glass-nav">
      {navLinks.map((link) => (
        link.children ? (
          <div class="accordion-glass" data-accordion-glass>
            <button type="button" class="accordion-glass-trigger">
              <svg class="accordion-glass-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {link.icon.paths.map((p) => <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d={p} />)}
              </svg>
              <span class="accordion-glass-label">{link.label}</span>
              <svg class="accordion-glass-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="accordion-glass-panel">
              <div class="accordion-glass-panel-inner">
                {link.children.map((child) => (
                  <LocalizedLink href={child.href} class="accordion-glass-link">{child.label}</LocalizedLink>
                ))}
              </div>
            </div>
          </div>
        ) : (
          <LocalizedLink href={link.href} class="mobile-link-glass">
            <svg class="accordion-glass-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              {link.icon.paths.map((p) => <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d={p} />)}
            </svg>
            <span>{link.label}</span>
          </LocalizedLink>
        )
      ))}
    </nav>
    <div class="panel-glass-footer">
      <!-- Theme Switcher: Full width, no label (self-explanatory) -->
      <div class="panel-glass-theme-row">
        <ThemeSwitcher variant="mobile" />
      </div>
      
      <!-- Language Switcher: Compact row -->
      <div class="panel-glass-footer-row">
        <span class="panel-glass-label">{t('languageSwitcher.label')}</span>
        <LanguageSwitcher variant="mobile" />
      </div>
    </div>
  </div>
</div>

<script>
  import { initNavOverflow } from '../../../utils/navOverflow';
  let glassController: AbortController | null = null;

  function initHeaderGlass() {
    glassController?.abort();
    glassController = new AbortController();
    const { signal } = glassController;

    const burger = document.getElementById('burger-glass');
    const panel = document.getElementById('panel-glass');
    
    if (!burger || !panel) return;

    function closePanel() {
      if (!panel || !burger) return;
      panel.classList.remove('is-open');
      burger.classList.remove('is-active');
      document.body.style.overflow = '';
    }

    function openPanel() {
      if (!panel || !burger) return;
      panel.classList.add('is-open');
      burger.classList.add('is-active');
      document.body.style.overflow = 'hidden';
      if (navigator.vibrate) navigator.vibrate(5);
    }

    burger.addEventListener('click', () => {
      panel.classList.contains('is-open') ? closePanel() : openPanel();
    }, { signal });

    panel.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', closePanel, { signal });
    });

    // Escape key handler
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && panel.classList.contains('is-open')) {
        closePanel();
        burger.focus();
      }
    }, { signal });

    // Desktop dropdowns
    document.querySelectorAll('[data-dropdown-glass]').forEach(dropdown => {
      const trigger = dropdown.querySelector('.nav-glass-item');
      if (!trigger) return;
      
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('[data-dropdown-glass].is-open').forEach(d => {
          if (d !== dropdown) d.classList.remove('is-open');
        });
        dropdown.classList.toggle('is-open');
      }, { signal });
    });

    document.addEventListener('click', () => {
      document.querySelectorAll('[data-dropdown-glass].is-open').forEach(d => d.classList.remove('is-open'));
    }, { signal });

    // Mobile accordions
    document.querySelectorAll('[data-accordion-glass]').forEach(accordion => {
      const trigger = accordion.querySelector('.accordion-glass-trigger');
      if (!trigger) return;
      
      trigger.addEventListener('click', () => {
        accordion.classList.toggle('is-open');
      }, { signal });
    });

    // Nav overflow "More" menu
    initNavOverflow({
      navSelector: '.nav-glass',
      itemSelector: ':scope > a, :scope > div:not([data-nav-more])',
      moreSelector: '[data-nav-more]',
      moreMenuSelector: '[data-nav-more-menu]',
      signal,
    });
  }

  initHeaderGlass();
  document.addEventListener('astro:after-swap', initHeaderGlass);
</script>

---
/**
 * LuxuryHeaderDesktop.astro
 * 
 * "The Studio Header" - A premium, horizontal, glassmorphic header.
 * Replaces the "Monolith" sidebar on Desktop.
 */
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';
import LocalizedLink from '../../ui/LocalizedLink.astro';
import { buildThemeNavLinks } from '../../../config/navigation';
import { getEnabledLocales, getEnabledLocaleCodes, defaultLocale } from '../../../config/locales';
import { getRelativeLocaleUrl } from 'astro:i18n';

import { palettes, getPaletteIds } from '../../../config/palettes';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const navLinks = buildThemeNavLinks(t, 'luxury');

// Path Logic for Language Switcher — dynamic for all locales
const currentPath = Astro.url.pathname;
const localeCodes = getEnabledLocaleCodes();
const localePattern = new RegExp(`^/(${localeCodes.join('|')})(/|$)`);
const cleanPath = currentPath.replace(localePattern, '/$2').replace(/^\/\//, '/') || '/';

const enabledLocales = getEnabledLocales();
const localePaths = enabledLocales.map(loc => ({
  code: loc.code,
  label: loc.code.toUpperCase(),
  nativeName: loc.nativeName,
  href: getRelativeLocaleUrl(loc.code, cleanPath),
  isActive: locale === loc.code,
}));

const themes = palettes.map(p => ({
  id: p.id, label: p.id.charAt(0).toUpperCase() + p.id.slice(1), color: p.accentHex,
}));
---

<header class="luxury-desktop-header hidden lg:grid">
  <!-- Left: Logo -->
  <div class="luxury-header-left">
    <LocalizedLink href={`/${locale === 'en' ? '' : locale}`} class="luxury-logo-text">
      Liquid
    </LocalizedLink>
  </div>

  <!-- Center: Navigation -->
  <nav class="luxury-header-center">
    {navLinks.map((link) => (
      <LocalizedLink href={link.href} class="luxury-nav-link">
        {link.label}
      </LocalizedLink>
    ))}
  </nav>

  <!-- Right: Controls -->
  <div class="luxury-header-right">
    <!-- Language -->
    <div class="luxury-control-group">
      {localePaths.map((loc, i) => (
        <>
          {i > 0 && <span class="luxury-divider">/</span>}
          <a href={loc.href} class={`luxury-action-link ${loc.isActive ? 'is-active' : ''}`}>{loc.label}</a>
        </>
      ))}
    </div>

    <div class="luxury-separator"></div>

    <!-- Theme (Simple Cycler or Icon) -->
    <button class="luxury-theme-trigger" id="luxury-desktop-theme-btn" aria-label="Theme">
      <div class="w-3 h-3 rounded-full border border-current bg-current opacity-80"></div>
      <span class="text-xs uppercase tracking-widest opacity-60 ml-2">Theme</span>
    </button>
  </div>
</header>

<style>
  .luxury-desktop-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    z-index: 100;
    
    /* Grid Layout */
    grid-template-columns: auto 1fr auto;
    align-items: center;
    padding: 0 32px;
    
    /* Glassmorphism */
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* Dark mode adjustment */
  :global([data-theme="abyss"] .luxury-desktop-header) {
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  }

  /* Left: Logo */
  .luxury-logo-text {
    font-family: var(--font-serif);
    font-size: 1.75rem;
    font-weight: 700;
    color: hsl(var(--bc));
    text-decoration: none;
    letter-spacing: -0.03em;
  }

  /* Center: Nav */
  .luxury-header-center {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: nowrap;
    white-space: nowrap;
    overflow: hidden;
  }

  .luxury-nav-link {
    font-family: var(--font-sans); 
    /* Ideally we'd use a clean sans here, assuming global sans is available */
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: hsl(var(--bc) / 0.6);
    text-decoration: none;
    transition: color 0.3s ease;
    font-weight: 500;
  }
  
  .luxury-nav-link:hover {
    color: hsl(var(--bc));
  }

  /* Right: Controls */
  .luxury-header-right {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 24px;
  }

  .luxury-control-group {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: nowrap;
    white-space: nowrap;
  }

  .luxury-action-link {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: hsl(var(--bc) / 0.4);
    text-decoration: none;
    transition: color 0.3s ease;
  }
  
  .luxury-action-link:hover, .luxury-action-link.is-active {
    color: hsl(var(--bc));
  }

  .luxury-divider {
    color: hsl(var(--bc) / 0.2);
    font-size: 0.75rem;
  }

  .luxury-separator {
    width: 1px;
    height: 16px;
    background: hsl(var(--bc) / 0.1);
  }

  .luxury-theme-trigger {
    background: none;
    border: none;
    display: flex;
    align-items: center;
    cursor: pointer;
    color: hsl(var(--bc));
    padding: 0;
  }
</style>

<script>
  // Theme Cycler — reads available palettes from rendered buttons
  document.getElementById('luxury-desktop-theme-btn')?.addEventListener('click', () => {
    // Collect all available palette IDs from the spine buttons
    const spineButtons = document.querySelectorAll('[data-set-theme-spine]');
    const themes = Array.from(spineButtons).map(b => (b as HTMLElement).dataset.setThemeSpine).filter(Boolean) as string[];
    if (themes.length === 0) return;

    const currentTheme = document.documentElement.getAttribute('data-theme') || 'azure';
    const currentIndex = themes.indexOf(currentTheme);
    const nextTheme = themes[(currentIndex + 1) % themes.length];
    
    document.documentElement.setAttribute('data-theme', nextTheme);
    localStorage.setItem('theme', nextTheme);
    window.dispatchEvent(new Event('theme-changed'));
  });
</script>

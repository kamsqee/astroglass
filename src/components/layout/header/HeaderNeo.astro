---
/**
 * HeaderNeo ‚Äî Shrink-on-Scroll Navigation Bar
 *
 * Desktop: Full-width transparent bar with all nav links inline.
 *          Shrinks to a compact centered pill on scroll.
 *          Dropdowns for Services and Resources.
 * Mobile:  Hamburger ‚Üí fullscreen overlay with expandable children.
 */
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';
import LocalizedLink from '../../ui/LocalizedLink.astro';
import { buildThemeNavLinks } from '../../../config/navigation';
import Logo from '../../ui/Logo.astro';
import ThemeSwitcher from '../../ui/ThemeSwitcher.astro';
import LanguageSwitcher from '../../ui/LanguageSwitcher.astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const navLinks = buildThemeNavLinks(t, 'neo');
import '../../../styles/components/header/HeaderNeo.css';
import '../../../styles/components/header/NavOverflow.css';

const moreLabel = t('nav.more', { silent: true }) || 'More';
---

<!-- Desktop Header (Neo-style glass pill) -->
<div class="hidden lg:block">
  <header class="header-neo" id="header-neo">
    <div class="header-neo-inner">
      <!-- Logo -->
      <LocalizedLink href="/" class="logo-neo" aria-label={t('nav.home')}>
        <span class="logo-neo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2.5C12 2.5 4 10 4 14.5C4 18.92 7.58 22.5 12 22.5C16.42 22.5 20 18.92 20 14.5C20 10 12 2.5 12 2.5Z"/>
            <path d="M8.5 14L12 8L15.5 14L12 18Z"/>
          </svg>
        </span>
        <span class="logo-neo-text">{t('siteName')}</span>
      </LocalizedLink>

      <!-- Desktop Navigation -->
      <nav class="nav-neo">
        {navLinks.map((link) => (
          link.children ? (
            <div class="dropdown-neo" data-dropdown-neo>
              <button type="button" class="nav-neo-link" aria-expanded="false">
                {link.label}
                <svg class="nav-neo-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="dropdown-neo-menu">
                {link.children.map((child) => (
                  <LocalizedLink href={child.href} class="dropdown-neo-item">{child.label}</LocalizedLink>
                ))}
              </div>
            </div>
          ) : (
            <LocalizedLink href={link.href} class="nav-neo-link">{link.label}</LocalizedLink>
          )
        ))}

        {/* Overflow "More" dropdown */}
        <div class="dropdown-neo" data-nav-more>
          <button type="button" class="nav-neo-link nav-more-trigger" aria-expanded="false">
            {moreLabel}
            <svg class="nav-neo-chevron nav-more-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="dropdown-neo-menu nav-more-menu" data-nav-more-menu></div>
        </div>
      </nav>

      <!-- Desktop Actions -->
      <div class="header-neo-actions">
        <ThemeSwitcher />
        <div class="header-neo-divider"></div>
        <LanguageSwitcher />
      </div>
    </div>
  </header>
</div>

<!-- Mobile Header (Liquid-style sticky bar) -->
<header id="mobile-header-neo" class="header-liquid sticky top-0 z-50 lg:hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="flex items-center justify-between h-16">
      <Logo />
      <button type="button" class="hamburger-btn" id="menu-toggle-neo" aria-label={t('nav.menu')}>
        <div class="hamburger-icon" id="hamburger-icon-neo">
          <span></span>
          <span></span>
        </div>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Navigation (Liquid-style) -->
<nav class="mobile-nav" id="mobile-nav-neo">
  <!-- Decorative elements -->
  <div class="mobile-nav-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <div class="relative z-10 flex flex-col h-full">
    <!-- Single scrollable area for everything -->
    <div class="flex-1 overflow-y-auto scrollbar-hide">
      <!-- Navigation Links Section -->
      <div class="mobile-nav-section">
        <div class="mobile-section-label">
          <span class="mobile-section-dot"></span>
          <span>{t('nav.menu') || 'Menu'}</span>
        </div>
        <div class="mobile-nav-links">
          {navLinks.map((link) => (
            link.children ? (
              <div class="mobile-dropdown" data-mobile-dropdown>
                <button
                  type="button"
                  class="mobile-dropdown-trigger mobile-nav-item group flex items-center justify-between w-full h-auto p-0 hover:bg-transparent"
                >
                  <div class="flex items-center gap-3.5">
                    <span class="mobile-nav-icon">
                      <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {link.icon.paths.map((path) => (
                          <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width={link.icon.strokeWidth || 1.75} 
                            d={path} 
                          />
                        ))}
                      </svg>
                    </span>
                    <span class="text-[15px] font-semibold">{link.label}</span>
                  </div>
                  <span class="mobile-nav-chevron">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </span>
                </button>
                <div class="mobile-dropdown-menu">
                  <div class="py-1.5 pl-[52px] pr-3 space-y-0.5">
                    {link.children.map((child) => (
                      child.children ? (
                        <!-- Nested mobile dropdown -->
                        <div class="mobile-nested-dropdown" data-mobile-nested>
                          <button
                            type="button"
                            class="mobile-nested-trigger mobile-subnav-item w-full justify-between h-auto p-0 hover:bg-transparent"
                          >
                            <span class="flex items-center gap-2.5">
                              <span>{child.label}</span>
                            </span>
                            <svg class="w-3.5 h-3.5 opacity-40 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                          </button>
                          <div class="mobile-nested-menu">
                            <div class="py-1 pl-6 space-y-0.5">
                              {child.children.map((subChild) => (
                                <LocalizedLink href={subChild.href} class="mobile-subnav-item text-[13px] justify-start w-full h-auto p-0 hover:bg-transparent font-normal">
                                  <span>{subChild.label}</span>
                                </LocalizedLink>
                              ))}
                            </div>
                          </div>
                        </div>
                      ) : (
                        <LocalizedLink href={child.href} class="mobile-subnav-item justify-start w-full h-auto p-0 hover:bg-transparent font-normal">
                          <span>{child.label}</span>
                        </LocalizedLink>
                      )
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <LocalizedLink href={link.href} class="mobile-nav-item group justify-start w-full h-auto p-0 hover:bg-transparent font-normal">
                <span class="mobile-nav-icon">
                  <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {link.icon.paths.map((path) => (
                      <path 
                        stroke-linecap="round" 
                        stroke-linejoin="round" 
                        stroke-width={link.icon.strokeWidth || 1.75} 
                        d={path} 
                      />
                    ))}
                  </svg>
                </span>
                <span class="text-[15px] font-semibold">{link.label}</span>
              </LocalizedLink>
            )
          ))}
        </div>
      </div>

      <!-- Preferences Section -->
      <div class="mobile-nav-section mobile-nav-section-preferences">
        <div class="mobile-section-label">
          <span class="mobile-section-dot"></span>
          <span>{t('nav.preferences') || 'Preferences'}</span>
        </div>

        <!-- Theme Selection -->
        <div class="preference-item">
          <div class="preference-header">
            <span class="preference-icon">üé®</span>
            <div class="preference-info">
              <span class="preference-title">{t('themeSwitcher.label')}</span>
              <span class="preference-hint">{t('themeSwitcher.hint') || 'Swipe to explore'}</span>
            </div>
          </div>
          <ThemeSwitcher variant="mobile" />
        </div>

        <!-- Language Selection -->
        <div class="preference-item">
          <div class="preference-header">
            <span class="preference-icon">üåê</span>
            <div class="preference-info">
              <span class="preference-title">{t('languageSwitcher.label')}</span>
              <span class="preference-hint">{t('languageSwitcher.hint') || 'Choose language'}</span>
            </div>
          </div>
          <LanguageSwitcher variant="mobile" />
        </div>
      </div>

      <!-- Bottom safe area spacer -->
      <div class="mobile-nav-spacer"></div>
    </div>
  </div>
</nav>

<script>
  import { initNavOverflow } from '../../../utils/navOverflow';
  let neoController: AbortController | null = null;

  function initHeaderNeo() {
    neoController?.abort();
    neoController = new AbortController();
    const { signal } = neoController;

    const header = document.getElementById('header-neo');

    if (!header) return;

    // ---- Dynamic Width Calculation (Desktop) ----
    const calculateDynamicWidth = () => {
      // Only needed for desktop
      if (window.innerWidth < 1024) return;
      
      const inner = header.querySelector('.header-neo-inner') as HTMLElement;
      if (!inner) return;

      // Measure natural fit-content
      inner.style.maxWidth = 'max-content';
      
      // Get the bounding width
      const naturalWidth = inner.offsetWidth;
      
      // Clean up inline style
      inner.style.maxWidth = '';
      
      // Add a tiny buffer (~2px) for subpixel rounding issues
      const finalWidth = naturalWidth + 2;
      
      // Set the CSS variable
      header.style.setProperty('--scrolled-max-width', `${finalWidth}px`);
    };

    // Calculate immediately and on resize
    calculateDynamicWidth();

    // ---- Shrink-on-scroll (desktop only) ----
    const onScroll = () => {
      header.classList.toggle('is-scrolled', window.scrollY > 60);
    };
    window.addEventListener('scroll', onScroll, { passive: true, signal });
    onScroll();

    // ---- Desktop dropdowns ----
    document.querySelectorAll('[data-dropdown-neo]').forEach(dropdown => {
      const trigger = dropdown.querySelector('.nav-neo-link');
      if (!trigger) return;
      
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('[data-dropdown-neo].is-open').forEach(d => {
          if (d !== dropdown) d.classList.remove('is-open');
        });
        dropdown.classList.toggle('is-open');
      }, { signal });
    });

    document.addEventListener('click', () => {
      document.querySelectorAll('[data-dropdown-neo].is-open').forEach(d => d.classList.remove('is-open'));
    }, { signal });

    // ---- Mobile menu (Liquid-style) ----
    const btn = document.getElementById('menu-toggle-neo');
    const nav = document.getElementById('mobile-nav-neo');

    if (!btn || !nav) return;

    function closeMenu() {
      if (!nav || !btn) return;
      nav.classList.remove('is-open');
      btn.classList.remove('is-active');
      const mobileHeader = document.getElementById('mobile-header-neo');
      if (mobileHeader) mobileHeader.classList.remove('is-menu-open');
      document.body.style.overflow = '';
      nav.querySelectorAll('.mobile-dropdown.is-open').forEach(d => d.classList.remove('is-open'));
      nav.querySelectorAll('.mobile-nested-dropdown.is-open').forEach(d => d.classList.remove('is-open'));
    }

    function openMenu() {
      if (!nav || !btn) return;
      nav.classList.add('is-open');
      btn.classList.add('is-active');
      const mobileHeader = document.getElementById('mobile-header-neo');
      if (mobileHeader) mobileHeader.classList.add('is-menu-open');
      document.body.style.overflow = 'hidden';
    }

    closeMenu();

    btn.addEventListener('click', () => {
      nav.classList.contains('is-open') ? closeMenu() : openMenu();
    }, { signal });

    // Close on link click
    nav.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', closeMenu, { signal });
    });

    // Mobile dropdown toggles
    nav.querySelectorAll('[data-mobile-dropdown]').forEach(dropdown => {
      const trigger = dropdown.querySelector('.mobile-dropdown-trigger');
      if (!trigger) return;

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropdown.classList.toggle('is-open');
      }, { signal });
    });

    // Mobile nested dropdown toggles
    nav.querySelectorAll('[data-mobile-nested]').forEach(nestedDropdown => {
      const trigger = nestedDropdown.querySelector('.mobile-nested-trigger');
      if (!trigger) return;

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        nestedDropdown.classList.toggle('is-open');
      }, { signal });
    });

    // Handle keyboard escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && nav.classList.contains('is-open')) {
        closeMenu();
        btn.focus();
      }
    }, { signal });

    // Handle window resize
    let resizeTimer: ReturnType<typeof setTimeout>;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        calculateDynamicWidth();
        if (window.innerWidth >= 1024 && nav.classList.contains('is-open')) {
          closeMenu();
        }
      }, 100);
    }, { signal });

    // Nav overflow "More" menu
    initNavOverflow({
      navSelector: '.nav-neo',
      itemSelector: ':scope > a, :scope > div:not([data-nav-more])',
      moreSelector: '[data-nav-more]',
      moreMenuSelector: '[data-nav-more-menu]',
      signal,
    });
  }

  initHeaderNeo();
  document.addEventListener('astro:after-swap', initHeaderNeo);
</script>


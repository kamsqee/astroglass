---
/**
 * HeaderLuxury — Editorial Bottom Sheet Navigation
 *
 * Desktop: elegant vertical sidebar.
 * Mobile: "Editorial" bottom sheet with drill-down interactions.
 */
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';
import LocalizedLink from '../../ui/LocalizedLink.astro';
import { buildLuxuryNavLinks } from '../../../config/navigation';
import ThemeSwitcher from '../../ui/ThemeSwitcher.astro';
import LanguageSwitcher from '../../ui/LanguageSwitcher.astro';
import SidebarStructureLuxury from './SidebarStructureLuxury.astro';
import { getEnabledLocales, getEnabledLocaleCodes } from '../../../config/locales';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { palettes } from '../../../config/palettes';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const navLinks = buildLuxuryNavLinks(t);
const activeLink = Astro.url.pathname;

// Language Logic: Preserve current path — dynamic for all locales
const currentPath = Astro.url.pathname;
const localeCodes = getEnabledLocaleCodes();
const localePattern = new RegExp(`^/(${localeCodes.join('|')})(/|$)`);
const cleanPath = currentPath.replace(localePattern, '/$2').replace(/^\/\//, '/') || '/';

const enabledLocales = getEnabledLocales();
const localePaths = enabledLocales.map(loc => ({
  code: loc.code,
  label: loc.code.toUpperCase(),
  nativeName: loc.nativeName,
  href: getRelativeLocaleUrl(loc.code, cleanPath),
  isActive: locale === loc.code,
}));

const currentLocaleConfig = enabledLocales.find(l => l.code === locale);

import '../../../styles/components/header/HeaderLuxury.css';
---

<!-- Mobile Header Bar -->
<div class="luxury-mobile-bar">
  <LocalizedLink href="/" class="luxury-logo">
    <span class="luxury-logo-inner">LG</span>
  </LocalizedLink>
  
  <button type="button" class="hamburger-btn" id="menu-toggle-luxury" aria-label="Toggle menu">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
    </div>
  </button>
</div>

<!-- Desktop Sidebar (Unchanged) -->
<div class="luxury-desktop-wrapper hidden lg:block">
  <!-- Desktop: The Architectural Spine -->
  <SidebarStructureLuxury />
</div>

<!-- Mobile (Unchanged) -->
<div class="luxury-mobile-bar"></div>

<!-- Mobile Navigation (Editorial Design) -->
<nav class="luxury-mobile-menu" id="luxury-mobile-menu">
  <!-- Backdrop (Click to close) -->
  <div class="luxury-backdrop" id="luxury-menu-backdrop"></div>

  <div class="luxury-sheet">
    
    <div class="luxury-nav-container">
      <!-- Main Panel (Simplified for Luxury: Flat List) -->
      <div class="luxury-panel is-active" id="panel-main">
        {navLinks.map((link) => (
           <LocalizedLink 
             href={link.href} 
             class="luxury-big-link"
           >
             <span>{link.label}</span>
             {link.type === 'page' && 
             <span class="luxury-arrow">
               <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                 <line x1="7" y1="17" x2="17" y2="7"></line>
                 <polyline points="7 7 17 7 17 17"></polyline>
               </svg>
             </span>
           }
           </LocalizedLink>
        ))}
      </div>
    </div>

    <!-- Editorial Context Controls -->
    <div class="luxury-sheet-footer">
      <div class="luxury-controls-row">
        
        <!-- Theme Control -->
        <div class="luxury-control-group">
          <span class="luxury-control-label">{t('themeSwitcher.label') || 'Theme'}</span>
          <button class="luxury-control-trigger" data-toggle-control="theme">
            <span class="luxury-control-value" id="current-theme-label">{t('themeSwitcher.themes.default') || 'Default'}</span>
            <span class="text-xs opacity-50">↓</span>
          </button>
          <div class="luxury-control-list" id="theme-list">
             {palettes.map(p => (
               <button class="luxury-control-option" data-set-theme={p.id}>
                 {p.id.charAt(0).toUpperCase() + p.id.slice(1)}
               </button>
             ))}
          </div>
        </div>

        <!-- Language Control -->
        <div class="luxury-control-group items-end">
          <span class="luxury-control-label">{t('languageSwitcher.label') || 'Language'}</span>
          <button class="luxury-control-trigger" data-toggle-control="lang">
            <span class="luxury-control-value">{currentLocaleConfig?.nativeName || locale.toUpperCase()}</span>
            <span class="text-xs opacity-50">↓</span>
          </button>
          <div class="luxury-control-list" id="lang-list">
            {localePaths.map(loc => (
              <a href={loc.href} class={`luxury-control-option ${loc.isActive ? 'is-selected' : ''}`}>
                {loc.nativeName}
              </a>
            ))}
          </div>
        </div>

      </div>
    </div>
  </div>
</nav>

<script>
  let luxuryHeaderController: AbortController | null = null;

  function initHeaderLuxury() {
    luxuryHeaderController?.abort();
    luxuryHeaderController = new AbortController();
    const { signal } = luxuryHeaderController;

    const nav = document.getElementById('luxury-mobile-menu');
    const toggleBtn = document.getElementById('menu-toggle-luxury');
    const backdrop = document.getElementById('luxury-menu-backdrop');
    
    if (!nav || !toggleBtn) return;

    // Helper to update labels
    const updateControlLabel = (theme: string) => {
       const label = document.getElementById('current-theme-label');
       if (label) {
         label.innerText = theme.charAt(0).toUpperCase() + theme.slice(1);
       }
       document.querySelectorAll('[data-set-theme]').forEach(el => {
          if (el.getAttribute('data-set-theme') === theme) {
            el.classList.add('is-selected');
          } else {
            el.classList.remove('is-selected');
          }
       });
    };

    // Initialize current label
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-palette') || 'azure';
    updateControlLabel(currentTheme);

    // --- Core Open/Close Logic ---

    const openMenu = () => {
      nav.classList.add('is-open');
      toggleBtn.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    };

    const closeMenu = () => {
      nav.classList.remove('is-open');
      toggleBtn.classList.remove('is-active');
      document.body.style.overflow = '';
      document.querySelectorAll('.luxury-control-group').forEach(g => g.classList.remove('is-open'));
    };

    const toggleMenu = (e: Event) => {
      e.stopPropagation();
      nav.classList.contains('is-open') ? closeMenu() : openMenu();
    };

    // --- Event Listeners ---
    
    toggleBtn.addEventListener('click', toggleMenu, { signal });

    if (backdrop) {
       backdrop.addEventListener('click', closeMenu, { signal });
    }

    nav.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', closeMenu, { signal });
    });

    // Escape Key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && nav.classList.contains('is-open')) {
        closeMenu();
      }
    }, { signal });

    // --- Controls Logic (Theme/Lang) ---
    nav.querySelectorAll('[data-toggle-control]').forEach(trigger => {
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          const group = trigger.closest('.luxury-control-group');
          const wasOpen = group?.classList.contains('is-open');
          
          document.querySelectorAll('.luxury-control-group').forEach(g => g.classList.remove('is-open'));

          if (!wasOpen) {
            group?.classList.add('is-open');
          }
        }, { signal });
    });
    
    // Close controls when clicking elsewhere in the sheet
    const sheet = nav.querySelector('.luxury-sheet');
    if (sheet) {
        sheet.addEventListener('click', (e: Event) => {
            const target = e.target as HTMLElement;
            if (!target.closest('.luxury-control-group')) {
                document.querySelectorAll('.luxury-control-group').forEach(g => g.classList.remove('is-open'));
            }
        }, { signal });
    }

    // --- Theme Selection Logic ---
    nav.querySelectorAll('[data-set-theme]').forEach(option => {
       option.addEventListener('click', (e) => {
         const theme = (e.currentTarget as HTMLElement).dataset.setTheme;
         if (theme) {
            const html = document.documentElement;
            html.setAttribute('data-palette', theme);
            localStorage.setItem('palette', theme);
            updateControlLabel(theme);
         }
       }, { signal });
    });
  }

  initHeaderLuxury();
  document.addEventListener('astro:after-swap', initHeaderLuxury);
</script>

---
/**
 * Dynamic Theme Page — Landing Route
 *
 * Generates /{theme} for each enabled theme via getStaticPaths().
 *
 * HOW SECTION ORDER IS CONTROLLED:
 *   Edit src/config/manifests/{theme}.ts → landingSections[]
 *
 * HOW TO ADD A SECTION TO ONE THEME:
 *   1. Create the section component (e.g. NewSectionLiquid.astro)
 *   2. Export it from the theme barrel: src/components/sections/themes/{theme}.ts
 *   3. Add its key to src/config/manifests/{theme}.ts → landingSections[]
 *
 * HOW TO ADD A NEW THEME:
 *   1. Create a manifest at src/config/manifests/{theme}.ts
 *   2. Register it in src/config/themes.ts → allThemes[]
 *   3. Create src/components/sections/themes/{theme}.ts barrel file
 *   4. Add the theme module to the themeModules map below
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import { useTranslations } from '../../utils/i18n';
import { getLocaleFromUrl } from '../../utils/locale-utils';
import { getThemeById, getLandingSections } from '../../config/themes';

// Theme barrel files (typed via src/types/theme-sections.d.ts)
import * as LiquidSections  from '../../components/sections/themes/liquid';
import * as GlassSections   from '../../components/sections/themes/glass';
import * as NeoSections     from '../../components/sections/themes/neo';
import * as LuxurySections  from '../../components/sections/themes/luxury';
import * as MinimalSections from '../../components/sections/themes/minimal';
import * as AuroraSections  from '../../components/sections/themes/aurora';

/** Shape of each theme module — keyed by section name, values are Astro components. */
type ThemeModuleMap = Record<string, Record<string, unknown>>;

export async function getStaticPaths() {
  const { getEnabledThemes } = await import('../../config/themes');
  const { isSingleTheme } = await import('../../config/config-loader');
  const { getEnabledLocaleCodes, defaultLocale } = await import('../../config/locales');

  // In single-theme mode, the theme renders at index — no /{theme} routes
  if (isSingleTheme) return [];

  const themes = getEnabledThemes();
  const langs = getEnabledLocaleCodes();
  const paths = [];

  for (const lang of langs) {
    for (const theme of themes) {
      paths.push({
        params: {
          lang: lang === defaultLocale ? undefined : lang,
          theme: theme.id
        },
        props: { themeId: theme.id }
      });
    }
  }
  return paths;
}

interface Props {
  themeId: string;
}

const { themeId } = Astro.props;
const theme = getThemeById(themeId);
const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const landingSections = getLandingSections(themeId);

// Map of all theme section modules — add a new entry here when adding a new theme.
const themeModules: ThemeModuleMap = {
  liquid:  LiquidSections,
  glass:   GlassSections,
  neo:     NeoSections,
  luxury:  LuxurySections,
  minimal: MinimalSections,
  aurora:  AuroraSections,
};

const sections = themeModules[themeId] ?? LiquidSections;

// Layout components — always rendered, not part of the section preset.
const Header = sections['Header'] as (_props: Record<string, unknown>) => unknown;
const Footer = sections['Footer'] as (_props: Record<string, unknown>) => unknown;

// Resolve main content sections in manifest order.
// If a section key is listed in the manifest but not exported by the barrel file,
// it is silently skipped — no runtime error.
const mainSections = landingSections
  .map((key) => sections[key] ?? null)
  .filter((C): C is NonNullable<typeof C> => C !== null);
---

<BaseLayout
  title={`${theme?.name} Theme - ${t('title')}`}
  description={t('description')}
  showHeader={false}
>
  <Header />
  <main>
    {mainSections.map((Section: any) => <Section />)}
  </main>
  <Footer />
</BaseLayout>

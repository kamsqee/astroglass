---

import { getCollection } from 'astro:content';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import BlogCard from '../../../../components/blog/BlogCard.astro';
import TagFilter from '../../../../components/blog/TagFilter.astro';
import FooterIndex from '../../../../components/sections/footer/FooterIndex.astro';
import { useTranslations } from '../../../../utils/i18n';

export const prerender = true;

export async function getStaticPaths() {
  const { getEnabledLocaleCodes, defaultLocale } = await import('../../../../config/locales');
  const langs = getEnabledLocaleCodes();
  const posts = await getCollection('blog');
  const paths: { params: { lang: string | undefined; tag: string }; props: { tag: string; locale: string } }[] = [];

  for (const lang of langs) {
    const langPosts = posts.filter(post => post.slug.startsWith(`${lang}/`));
    const tags = new Set<string>();
    langPosts.forEach(post => post.data.tags.forEach((tag: string) => tags.add(tag)));
    
    [...tags].forEach(tag => {
      paths.push({
        params: { 
          lang: lang === defaultLocale ? undefined : lang,
          tag 
        },
        props: { tag, locale: lang },
      });
    });
  }
  return paths;
}

const { tag, locale } = Astro.props;
const t = useTranslations(locale);

const allPosts = await getCollection('blog', ({ slug, data }) => {
  return slug.startsWith(`${locale}/`) && !data.draft;
});
const posts = allPosts
  .filter(p => p.data.tags.includes(tag))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const allTags = [...new Set(allPosts.flatMap(p => p.data.tags))].sort();
---

<BaseLayout title={`${t('blog.tags')}: ${tag}`} description={`${t('blog.filterByTag')}: ${tag}`}>
  <div class="max-w-6xl mx-auto pb-20 px-4 sm:px-6 overflow-x-hidden" style="padding-top: calc(var(--nav-offset, 5rem) + 2rem)">
    <div class="mb-8">
      <a href="/blog" class="text-sm font-bold uppercase tracking-wider transition-colors" style={`color: hsl(var(--bc) / 0.4);`}>
        {t('blog.backToBlog')}
      </a>
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-black mt-3" style="overflow-wrap: break-word; word-break: break-word;">#{tag}</h1>
    </div>

    <TagFilter tags={allTags} activeTag={tag} />

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {posts.map(post => <BlogCard post={post} />)}
    </div>
  </div>
  <FooterIndex />
</BaseLayout>

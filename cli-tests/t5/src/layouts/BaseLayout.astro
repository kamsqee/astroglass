---
import { getLocaleFromUrl } from '../utils/locale-utils';
import { getEnabledLocaleCodes } from '../config/locales';
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import Header from '../components/layout/header/HeaderLiquid.astro';
import HeaderGlass from '../components/layout/header/HeaderGlass.astro';
import HeaderLuxury from '../components/layout/header/HeaderLuxury.astro';
import HeaderMinimal from '../components/layout/header/HeaderMinimal.astro';
import HeaderDefault from '../components/layout/header/HeaderDefault.astro';

export interface Props {
  title: string;
  description: string;
  showHeader?: boolean;
  headerVersion?: 1 | 2 | 3 | 4 | 5;
  ogImage?: string;
}

const { 
  title, 
  description, 
  showHeader = true, 
  headerVersion = 3, 
  ogImage,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site ?? Astro.url.origin);
const socialImageURL = ogImage ? new URL(ogImage, Astro.url.origin).href : new URL('/favicon.svg', Astro.url.origin).href;
const locale = getLocaleFromUrl(Astro.url);
const enabledLocales = getEnabledLocaleCodes();

// Use prop version or default to 1
const currentHeader = headerVersion;

// If Header Glass is active, force the 'nordic' theme
const activeTheme = currentHeader === 2 ? 'nordic' : 'azure';
---

<!doctype html>
<html lang={locale} data-theme={activeTheme} data-header={currentHeader}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL.href} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />

    <ClientRouter />
    <style is:global>
      /* Cinema Fade View Transitions */
      ::view-transition-group(root) {
        animation-duration: 0.6s;
      }
      
      ::view-transition-old(root) {
        animation: 0.5s cubic-bezier(0.4, 0, 0.2, 1) both fade-out-scale;
      }

      ::view-transition-new(root) {
        animation: 0.6s cubic-bezier(0.19, 1, 0.22, 1) both fade-in-scale;
        mix-blend-mode: normal;
      }

      @keyframes fade-out-scale {
        0% { opacity: 1; transform: scale(1); filter: blur(0px); }
        100% { opacity: 0; transform: scale(0.96); filter: blur(4px); }
      }

      @keyframes fade-in-scale {
        0% { opacity: 0; transform: scale(1.04); filter: blur(8px); }
        100% { opacity: 1; transform: scale(1); filter: blur(0px); }
      }

      /* Reduce motion preference */
      @media (prefers-reduced-motion: reduce) {
        ::view-transition-group(*),
        ::view-transition-old(*),
        ::view-transition-new(*) {
          animation: none !important;
        }
      }
    </style>
    <script is:inline define:vars={{ isGlass: currentHeader === 2 }}>
      const setSelectionTheme = () => {
        if (isGlass) {
          document.documentElement.setAttribute('data-theme', 'nordic');
        } else {
          const stored = localStorage.getItem('theme');
          if (stored) document.documentElement.setAttribute('data-theme', stored);
        }
        // Emit custom event so ThemeSwitchers can update their UI
        window.dispatchEvent(new CustomEvent('theme-changed', { 
            detail: { theme: document.documentElement.getAttribute('data-theme') } 
        }));
      };
      setSelectionTheme();
      document.addEventListener('astro:after-swap', setSelectionTheme);
    </script>
  </head>
  <body class="bg-base-100 text-base-content min-h-screen">
    {showHeader && (
      currentHeader === 1 ? <Header /> :
      currentHeader === 2 ? <HeaderGlass /> :
      currentHeader === 3 ? <HeaderDefault /> :
      currentHeader === 4 ? <HeaderLuxury /> :
      <HeaderMinimal />
    )}
    
    <div style="overflow-x: clip;">
      <slot />
    </div>

    <script is:inline define:vars={{ enabledLocales }}>
      // Apply stored locale preference to navigation links
      function applyLocalePreference() {
        const preferredLocale = localStorage.getItem('preferred-locale');
        if (!preferredLocale || preferredLocale === 'en') return;
        
        const pathname = window.location.pathname;
        
        // Only apply to navigation links on non-locale-prefixed pages
        if (pathname.startsWith('/' + preferredLocale)) return;
        
        // Build locale regex dynamically from config
        const localePattern = new RegExp('^/(' + enabledLocales.join('|') + ')/');
        
        // Update navigation links to include locale prefix
        document.querySelectorAll('nav a, .nav-glass a, .panel-glass a, .mobile-nav a, .header-neo a, .overlay-neo a, .overlay-aurora a, [data-mobile-dropdown] a').forEach(link => {
          const href = link.getAttribute('href');
          if (!href) return;
          
          // Skip external links, anchors-only, and already localized links
          if (href.startsWith('http') || href === '#' || href.startsWith('/' + preferredLocale) || localePattern.test(href)) return;
          
          // Add locale prefix to all internal links (including theme pages and hash links)
          if (href === '/') {
            link.setAttribute('href', '/' + preferredLocale + '/');
          } else if (href.startsWith('/')) {
            link.setAttribute('href', '/' + preferredLocale + href);
          }
        });
      }
      
      applyLocalePreference();
      document.addEventListener('astro:after-swap', applyLocalePreference);
    </script>
  </body>
</html>

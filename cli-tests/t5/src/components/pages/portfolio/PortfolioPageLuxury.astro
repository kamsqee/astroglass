---
/**
 * Portfolio Page — Luxury Theme (Composition Layer)
 * 
 * Wires data ↔ sub-components:
 *   - PortfolioHeroLuxury  → serif hero + diamond dividers + filters
 *   - PortfolioGridLuxury  → glass cards with number watermarks
 *   - PortfolioModalLuxury → overlay + pre-rendered templates
 *   - PortfolioCTALuxury   → bottom CTA
 */
import '../../../styles/components/portfolio/PortfolioPageLuxury.css';
import { useTranslations } from '../../../utils/i18n';
import { getLocaleFromUrl } from '../../../utils/locale-utils';

import PortfolioHeroLuxury from './luxury/PortfolioHeroLuxury.astro';
import PortfolioGridLuxury from './luxury/PortfolioGridLuxury.astro';
import PortfolioModalLuxury from './luxury/PortfolioModalLuxury.astro';
import PortfolioCTALuxury from './luxury/PortfolioCTALuxury.astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

const localePrefix = locale === 'en' ? '' : `/${locale}`;
const luxuryBase = `${localePrefix}/luxury`;

const categories = [
  { id: 'all', label: t('portfolioPage.filterAll') },
  { id: 'webapp', label: t('portfolio.categories.webapp') },
  { id: 'dashboard', label: t('portfolio.categories.dashboard') },
  { id: 'mobile', label: t('portfolio.categories.mobile') },
  { id: 'branding', label: t('portfolio.categories.branding') },
];

const projects = [
  {
    id: 'p1',
    title: t('portfolioPage.projects.p1.title'),
    description: t('portfolioPage.projects.p1.description'),
    longDescription: t('portfolioPage.projects.p1.longDescription'),
    category: 'webapp',
    categoryLabel: t('portfolioPage.projects.p1.category'),
    challenge: t('portfolioPage.projects.p1.challenge'),
    solution: t('portfolioPage.projects.p1.solution'),
    impact: t('portfolioPage.projects.p1.impact'),
    techStack: ['React', 'Node.js', 'GraphQL', 'Redis', 'AWS'],
    metric: t('portfolioPage.projects.p1.metric'),
    metricLabel: t('portfolioPage.projects.p1.metricLabel'),
    color: 'from-violet-500 to-purple-600',
    num: '01',
  },
  {
    id: 'p2',
    title: t('portfolioPage.projects.p2.title'),
    description: t('portfolioPage.projects.p2.description'),
    longDescription: t('portfolioPage.projects.p2.longDescription'),
    category: 'dashboard',
    categoryLabel: t('portfolioPage.projects.p2.category'),
    challenge: t('portfolioPage.projects.p2.challenge'),
    solution: t('portfolioPage.projects.p2.solution'),
    impact: t('portfolioPage.projects.p2.impact'),
    techStack: ['Vue.js', 'D3.js', 'Python', 'PostgreSQL', 'Docker'],
    metric: t('portfolioPage.projects.p2.metric'),
    metricLabel: t('portfolioPage.projects.p2.metricLabel'),
    color: 'from-cyan-500 to-blue-600',
    num: '02',
  },
  {
    id: 'p3',
    title: t('portfolioPage.projects.p3.title'),
    description: t('portfolioPage.projects.p3.description'),
    longDescription: t('portfolioPage.projects.p3.longDescription'),
    category: 'mobile',
    categoryLabel: t('portfolioPage.projects.p3.category'),
    challenge: t('portfolioPage.projects.p3.challenge'),
    solution: t('portfolioPage.projects.p3.solution'),
    impact: t('portfolioPage.projects.p3.impact'),
    techStack: ['Swift', 'SwiftUI', 'Firebase', 'Lottie', 'CoreData'],
    metric: t('portfolioPage.projects.p3.metric'),
    metricLabel: t('portfolioPage.projects.p3.metricLabel'),
    color: 'from-emerald-500 to-teal-600',
    num: '03',
  },
  {
    id: 'p4',
    title: t('portfolioPage.projects.p4.title'),
    description: t('portfolioPage.projects.p4.description'),
    longDescription: t('portfolioPage.projects.p4.longDescription'),
    category: 'branding',
    categoryLabel: t('portfolioPage.projects.p4.category'),
    challenge: t('portfolioPage.projects.p4.challenge'),
    solution: t('portfolioPage.projects.p4.solution'),
    impact: t('portfolioPage.projects.p4.impact'),
    techStack: ['Three.js', 'GSAP', 'WebGL', 'Astro', 'Cloudflare'],
    metric: t('portfolioPage.projects.p4.metric'),
    metricLabel: t('portfolioPage.projects.p4.metricLabel'),
    color: 'from-amber-500 to-orange-600',
    num: '04',
  },
  {
    id: 'p5',
    title: t('portfolioPage.projects.p5.title'),
    description: t('portfolioPage.projects.p5.description'),
    longDescription: t('portfolioPage.projects.p5.longDescription'),
    category: 'webapp',
    categoryLabel: t('portfolioPage.projects.p5.category'),
    challenge: t('portfolioPage.projects.p5.challenge'),
    solution: t('portfolioPage.projects.p5.solution'),
    impact: t('portfolioPage.projects.p5.impact'),
    techStack: ['Next.js', 'OpenAI', 'Prisma', 'Supabase', 'Vercel'],
    metric: t('portfolioPage.projects.p5.metric'),
    metricLabel: t('portfolioPage.projects.p5.metricLabel'),
    color: 'from-rose-500 to-pink-600',
    num: '05',
  },
  {
    id: 'p6',
    title: t('portfolioPage.projects.p6.title'),
    description: t('portfolioPage.projects.p6.description'),
    longDescription: t('portfolioPage.projects.p6.longDescription'),
    category: 'dashboard',
    categoryLabel: t('portfolioPage.projects.p6.category'),
    challenge: t('portfolioPage.projects.p6.challenge'),
    solution: t('portfolioPage.projects.p6.solution'),
    impact: t('portfolioPage.projects.p6.impact'),
    techStack: ['Remix', 'Shopify Hydrogen', 'Three.js', 'Stripe', 'Edge Functions'],
    metric: t('portfolioPage.projects.p6.metric'),
    metricLabel: t('portfolioPage.projects.p6.metricLabel'),
    color: 'from-indigo-500 to-violet-600',
    num: '06',
  },
];
---

<PortfolioHeroLuxury
  categories={categories}
  caseStudiesLabel={t('portfolio.caseStudies')}
  pageTitle={t('portfolioPage.pageTitle')}
  pageSubtitle={t('portfolioPage.pageSubtitle')}
/>

<PortfolioGridLuxury
  projects={projects}
  viewDetailsLabel={t('portfolioPage.viewDetails')}
/>

<PortfolioModalLuxury
  projects={projects}
  challengeLabel={t('portfolioPage.theChallenge')}
  solutionLabel={t('portfolioPage.theSolution')}
  impactLabel={t('portfolioPage.theImpact')}
  techStackLabel={t('portfolioPage.techStackLabel')}
/>

<PortfolioCTALuxury
  startProjectLabel={t('portfolioPage.startProject')}
  startProjectSubLabel={t('portfolioPage.startProjectSub')}
  backToHomeLabel={t('portfolioPage.backToHome')}
  contactHref={`${luxuryBase}#contact`}
  homeHref={luxuryBase}
/>

<script>
  import { registerAstroPage } from '../../../utils/lifecycle';
  import { initScrollReveal } from '../../../utils/animations';
  import { initCategoryFilter } from '../../../utils/portfolio';

  registerAstroPage((signal) => {
    if (!document.querySelector('.c-portfolio-page-luxury__card')) return;

    const modal = document.getElementById('pp-luxury-modal') as HTMLElement | null;
    const modalContent = document.getElementById('pp-luxury-modal-content') as HTMLElement | null;
    const modalClose = document.getElementById('pp-luxury-modal-close') as HTMLElement | null;
    if (!modal || !modalContent) return;

    function closeModal() {
      modal!.classList.remove('is-open');
      document.body.style.overflow = '';
      document.querySelectorAll('.c-portfolio-page-luxury__card.is-detail-active').forEach((c) => {
        c.classList.remove('is-detail-active');
      });
    }

    function openModal(index: number) {
      const tpl = document.querySelector<HTMLTemplateElement>(
        `template[data-luxury-modal-index="${index}"]`
      );
      if (!tpl) return;

      modalContent!.innerHTML = '';
      modalContent!.appendChild(tpl.content.cloneNode(true));

      // Mark active card
      document.querySelectorAll('.c-portfolio-page-luxury__card.is-detail-active').forEach((c) => {
        c.classList.remove('is-detail-active');
      });
      const cards = document.querySelectorAll('.c-portfolio-page-luxury__card');
      if (cards[index]) cards[index].classList.add('is-detail-active');

      modal!.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    // Close handlers
    if (modalClose) modalClose.addEventListener('click', closeModal, { signal });
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }, { signal });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal!.classList.contains('is-open')) closeModal();
    }, { signal });

    // Card "View Details" button click
    document.querySelectorAll<HTMLElement>('[data-open-luxury-modal]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(btn.getAttribute('data-open-luxury-modal') || '0', 10);
        openModal(index);
      }, { signal });
    });

    // Scroll-based card reveal with stagger
    initScrollReveal('.c-portfolio-page-luxury__card', {
      threshold: 0.1,
      rootMargin: '0px 0px -40px 0px',
      staggerMs: 80,
      signal,
    });

    // Category filter (closes modal on filter change)
    initCategoryFilter({
      filtersId: 'pp-luxury-filters',
      cardSelector: '.c-portfolio-page-luxury__card',
      activeClasses: ['border-accent/30', 'text-accent', 'bg-accent/[0.08]'],
      inactiveClasses: ['border-base-content/8', 'text-base-content/80'],
      twoStepAnimation: true,
      hideTransform: 'translateY(20px) scale(0.98)',
      onFilter: () => closeModal(),
      signal,
    });
  });
</script>

---
/**
 * Portfolio Page — Aurora Theme (Composition Layer)
 * 
 * Wires data ↔ sub-components. All visual HTML lives in aurora/:
 *   - PortfolioHeroAurora  → hero + filters
 *   - PortfolioGridAurora  → card grid
 *   - PortfolioModalAurora → overlay + pre-rendered templates
 *   - PortfolioCTAAurora   → bottom CTA
 */
import '../../../styles/components/portfolio/PortfolioPageAurora.css';
import { getLocaleFromUrl, useTranslations } from '../../../utils/i18n';

import PortfolioHeroAurora from './aurora/PortfolioHeroAurora.astro';
import PortfolioGridAurora from './aurora/PortfolioGridAurora.astro';
import PortfolioModalAurora from './aurora/PortfolioModalAurora.astro';
import PortfolioCTAAurora from './aurora/PortfolioCTAAurora.astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

const localePrefix = locale === 'en' ? '' : `/${locale}`;
const auroraBase = `${localePrefix}/aurora`;

const categories = [
  { id: 'all', label: t('portfolioPage.filterAll') },
  { id: 'webapp', label: t('portfolio.categories.webapp') },
  { id: 'dashboard', label: t('portfolio.categories.dashboard') },
  { id: 'mobile', label: t('portfolio.categories.mobile') },
  { id: 'branding', label: t('portfolio.categories.branding') },
];

const projects = [
  {
    id: 'p1',
    title: t('portfolioPage.projects.p1.title'),
    description: t('portfolioPage.projects.p1.description'),
    category: 'webapp',
    categoryLabel: t('portfolioPage.projects.p1.category'),
    challenge: t('portfolioPage.projects.p1.challenge'),
    solution: t('portfolioPage.projects.p1.solution'),
    impact: t('portfolioPage.projects.p1.impact'),
    techStack: ['React', 'Node.js', 'GraphQL', 'Redis', 'AWS'],
    metric: t('portfolioPage.projects.p1.metric'),
    metricLabel: t('portfolioPage.projects.p1.metricLabel'),
  },
  {
    id: 'p2',
    title: t('portfolioPage.projects.p2.title'),
    description: t('portfolioPage.projects.p2.description'),
    category: 'dashboard',
    categoryLabel: t('portfolioPage.projects.p2.category'),
    challenge: t('portfolioPage.projects.p2.challenge'),
    solution: t('portfolioPage.projects.p2.solution'),
    impact: t('portfolioPage.projects.p2.impact'),
    techStack: ['Vue.js', 'D3.js', 'Python', 'PostgreSQL', 'Docker'],
    metric: t('portfolioPage.projects.p2.metric'),
    metricLabel: t('portfolioPage.projects.p2.metricLabel'),
  },
  {
    id: 'p3',
    title: t('portfolioPage.projects.p3.title'),
    description: t('portfolioPage.projects.p3.description'),
    category: 'mobile',
    categoryLabel: t('portfolioPage.projects.p3.category'),
    challenge: t('portfolioPage.projects.p3.challenge'),
    solution: t('portfolioPage.projects.p3.solution'),
    impact: t('portfolioPage.projects.p3.impact'),
    techStack: ['Swift', 'SwiftUI', 'Firebase', 'Lottie', 'CoreData'],
    metric: t('portfolioPage.projects.p3.metric'),
    metricLabel: t('portfolioPage.projects.p3.metricLabel'),
  },
  {
    id: 'p4',
    title: t('portfolioPage.projects.p4.title'),
    description: t('portfolioPage.projects.p4.description'),
    category: 'branding',
    categoryLabel: t('portfolioPage.projects.p4.category'),
    challenge: t('portfolioPage.projects.p4.challenge'),
    solution: t('portfolioPage.projects.p4.solution'),
    impact: t('portfolioPage.projects.p4.impact'),
    techStack: ['Three.js', 'GSAP', 'WebGL', 'Astro', 'Cloudflare'],
    metric: t('portfolioPage.projects.p4.metric'),
    metricLabel: t('portfolioPage.projects.p4.metricLabel'),
  },
  {
    id: 'p5',
    title: t('portfolioPage.projects.p5.title'),
    description: t('portfolioPage.projects.p5.description'),
    category: 'webapp',
    categoryLabel: t('portfolioPage.projects.p5.category'),
    challenge: t('portfolioPage.projects.p5.challenge'),
    solution: t('portfolioPage.projects.p5.solution'),
    impact: t('portfolioPage.projects.p5.impact'),
    techStack: ['Next.js', 'OpenAI', 'Prisma', 'Supabase', 'Vercel'],
    metric: t('portfolioPage.projects.p5.metric'),
    metricLabel: t('portfolioPage.projects.p5.metricLabel'),
  },
  {
    id: 'p6',
    title: t('portfolioPage.projects.p6.title'),
    description: t('portfolioPage.projects.p6.description'),
    category: 'dashboard',
    categoryLabel: t('portfolioPage.projects.p6.category'),
    challenge: t('portfolioPage.projects.p6.challenge'),
    solution: t('portfolioPage.projects.p6.solution'),
    impact: t('portfolioPage.projects.p6.impact'),
    techStack: ['Remix', 'Shopify Hydrogen', 'Three.js', 'Stripe', 'Edge Functions'],
    metric: t('portfolioPage.projects.p6.metric'),
    metricLabel: t('portfolioPage.projects.p6.metricLabel'),
  },
];
---

<PortfolioHeroAurora
  categories={categories}
  badgeLabel={t('portfolio.badge')}
  pageTitle={t('portfolioPage.pageTitle')}
  pageSubtitle={t('portfolioPage.pageSubtitle')}
/>

<PortfolioGridAurora projects={projects} />

<PortfolioModalAurora
  projects={projects}
  challengeLabel={t('portfolioPage.theChallenge')}
  solutionLabel={t('portfolioPage.theSolution')}
  impactLabel={t('portfolioPage.theImpact')}
  techStackLabel={t('portfolioPage.techStackLabel')}
/>

<PortfolioCTAAurora
  startProjectLabel={t('portfolioPage.startProject')}
  startProjectSubLabel={t('portfolioPage.startProjectSub')}
  backToHomeLabel={t('portfolioPage.backToHome')}
  contactHref={`${auroraBase}#contact`}
  homeHref={auroraBase}
/>

<script>
  import { registerAstroPage } from '../../../utils/lifecycle';
  import { initScrollReveal } from '../../../utils/animations';
  import { initCategoryFilter } from '../../../utils/portfolio';

  registerAstroPage((signal) => {
    if (!document.querySelector('.pp-aurora__card')) return;

    const modal = document.getElementById('pp-aurora-modal') as HTMLElement | null;
    const modalContent = document.getElementById('pp-aurora-modal-content') as HTMLElement | null;
    const modalClose = document.getElementById('pp-aurora-modal-close') as HTMLElement | null;
    if (!modal || !modalContent) return;

    function closeModal() {
      modal!.classList.remove('is-open');
      document.body.style.overflow = '';
      document.querySelectorAll('.pp-aurora__card.is-detail-active').forEach((c) => {
        c.classList.remove('is-detail-active');
      });
    }

    function openModal(index: number) {
      const tpl = document.querySelector<HTMLTemplateElement>(
        `template[data-aurora-modal-index="${index}"]`
      );
      if (!tpl) return;

      modalContent!.innerHTML = '';
      modalContent!.appendChild(tpl.content.cloneNode(true));

      // Mark active card
      document.querySelectorAll('.pp-aurora__card.is-detail-active').forEach((c) => {
        c.classList.remove('is-detail-active');
      });
      const cards = document.querySelectorAll('.pp-aurora__card');
      if (cards[index]) cards[index].classList.add('is-detail-active');

      modal!.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    // Close button
    if (modalClose) modalClose.addEventListener('click', closeModal, { signal });

    // Backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    }, { signal });

    // Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal!.classList.contains('is-open')) {
        closeModal();
      }
    }, { signal });

    // Card click handlers — open modal by index
    document.querySelectorAll<HTMLElement>('.pp-aurora__card').forEach((card, i) => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', () => {
        openModal(i);
      }, { signal });
    });

    // Scroll reveal with stagger
    initScrollReveal('.pp-aurora__card', {
      threshold: 0.1,
      rootMargin: '0px 0px -30px 0px',
      staggerMs: 80,
      signal,
    });

    // Category filter (closes modal on filter, uses scale transform)
    initCategoryFilter({
      filtersId: 'pp-aurora-filters',
      cardSelector: '.pp-aurora__card',
      activeClasses: ['is-active'],
      inactiveClasses: [],
      twoStepAnimation: true,
      hideTransform: 'translateY(20px) scale(0.98)',
      onFilter: () => closeModal(),
      signal,
    });
  });
</script>
